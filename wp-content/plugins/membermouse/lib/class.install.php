<?php
/**
 * 
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 * 
 * MM_Install handles all install/update related tasks. The master schema is located in data/install_sql.php. 
 * Key things to remember when working with the master schema: 
 * 1. The wordpress dbdelta function is used to keep the schema in sync across versions. 
 *    Formatting is very important, please reference the initial schema when adding new tables
 * 2. PRIMARY KEYs need to be declared on a separate line (vs inline with the column definition. Two spaces need to
 *    follow the words PRIMARY KEY and the definition of that key, otherwise the dbdelta will fail
 * 3. FOREIGN KEYs are not currently supported and can potentially cause dbdeltas to fail.
 * 4. Each column or key definition needs to be on its own line. Lines are delimited by \n (unix-style newline)
 * 5. dbdelta() currently doesn't properly deal with backticks surrounding the column name in KEY definitions
 * 6. dbdelta() will add columns to existing tables, but will not drop removed columns. Those operations will need to be done manually 
 * 
 * With a properly formatted schema, the database structure will be synced to the schema on both install and update, eliminating the need for
 * version-specific update code and different code for installs vs updates. Default data with specified keys (either primary keys or unique column values) 
 * is inserted using INSERT IGNORE sql statements. This handles both insert and update scenarios because duplicate key errors are ignored if the data already exists.
 * 
 */
require_once(ABSPATH.'wp-admin/includes/upgrade.php');

 class MM_Install
 {
 	function __construct()
 	{
 		//default constructor
 	}
 	
 	public function activate()
 	{
 		global $wpdb;
 		ob_start();
 		
 		$error = "";
 		
	 	if($this->createDBCache())
	 	{
	 		if($this->updateMemberMouseClass())
	 		{
	 			// reset minor version if this is a major version upgrade
	 			$crntMajorVersion = MemberMouse::getPluginVersion();
	 			$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
	 			if (!empty($lastMajorVersion) && (version_compare($lastMajorVersion, $crntMajorVersion) < 0))
	 			{	
	 				MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION, MM_MemberMouseService::$DEFAULT_MINOR_VERSION); 
	 			}
	 			
		 		if($this->authenticateWithMM() !== false)
		 		{
		 			if($this->alterMMTables())
		 			{
		 				//628 patch
		 				if (method_exists('MM_MemberMouseService','regulateSchedulingEntries'))
						{
							MM_MemberMouseService::regulateSchedulingEntries();
						}
		 				
		 				if($this->insertMMDefaultData())
		 				{	 							
		 					// set new major version
		 					$crntMajorVersion = MemberMouse::getPluginVersion();
		 					MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION, $crntMajorVersion);
		 					
		 					//update version history
		 					$versionDescription = $crntMajorVersion;
		 					$minorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION);
		 					
		 					if($minorVersion !== false && intval($minorVersion) > 0)
		 					{
		 						$versionDescription .= "-".$minorVersion;
		 					}
		 					else
		 					{
		 						$versionDescription .= "-".MM_MemberMouseService::$DEFAULT_MINOR_VERSION;
		 					}
		 					
 							$versionRelease = MM_VersionRelease::findByVersion($versionDescription);
 							$versionRelease->setVersion($versionDescription);
 							$versionRelease->commitData();
 							
 							MM_MemberMouseService::activatePlugin();
 							 
 							// clear major version notice
 							$crntMajorVersion = MemberMouse::getPluginVersion();
 							$upgradeVersion = MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE);
 							if(!empty($upgradeVersion) && (version_compare($crntMajorVersion, $upgradeVersion, ">=")))
 							{
 								MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE, "");
 							}
 							
 							ob_end_clean();
	 						return true;	
		 				}
				 		else 
				 		{
	 						$error = "The MemberMouse installer could not install default data into the database. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
				 		}
		 			}
			 		else 
			 		{
	 					$error = "The MemberMouse installer was unable to alter MemberMouse tables. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
			 		}
		 		}
		 		else 
		 		{
		 			$error = "<div style='font-family: sans-serif; font-size: 13px;'>";
		 			
		 			$error .= "<h3 style='color:#BC0B0B; margin-top:0px; margin-bottom:5px; font-size: 14px;'>This site is not authorized to use the MemberMouse plugin</h3>";
		 			
		 			$error .= "<p style='margin-top:0px; margin-bottom:5px;'>In order to use the MemberMouse plugin you need to <a href=\"http://support.membermouse.com/support/solutions/articles/9000020222-installing-membermouse\" target=\_blank\">register your site with membermouse.com</a>.</p>";
		 			
		 			$error .= "</div>";
		 		}
	 		}
	 		else 
	 		{
	 			$error = "Unable to insert MM_MemberMouseService into mm_container table. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
	 		}
	 		
		}
		else 
		{
			$error = "Unable to install the mm_container table. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
		}
 		
	 	ob_end_clean();
	 	
 		// an error occurred so deactivate the plugin
		$this->showError($error);
		exit;
 	}
 	
 	
 	private function showError($error)
 	{
		echo $error; 
		@deactivate_plugins(MM_PLUGIN_ABSPATH."/index.php", false);
 	}
 	
 	
 	private function createDBCache()
 	{
 		global $wpdb;
 		
 		require_once(MM_PLUGIN_ABSPATH."/data/db_cache_sql.php");
 	
		if(isset($sql) && count($sql) > 0)
		{
			foreach($sql as $query)
			{
				try
				{
					$result = $wpdb->query($query);
					if(!$result) 
					{
						return false;
					}
				}
				catch(Exception $e)
				{
					return false;
				}
			}
			
			$countSql = "select count(*) as total from ".MM_TABLE_CONTAINER." where name='membermouseservice'";
			$row = $wpdb->get_row($countSql);
			
			if($row===false)
			{
				return false;
			}	
		}
		
		return true;
 	}
 	
 	public function updateMemberMouseClass()
 	{
 		global $wpdb;
 		
 		$removeSql = "DELETE FROM ".MM_TABLE_CONTAINER." WHERE name='membermouseservice'";
		$row = $wpdb->get_row($removeSql);
		$wpdb->query($removeSql);
		
		$addSql = "INSERT INTO ".MM_TABLE_CONTAINER." (name, obj, is_system, date_added) values ('membermouseservice', 'Ci8qKgogKiAKICogTWVtYmVyTW91c2UoVE0pIChodHRwOi8vd3d3Lm1lbWJlcm1vdXNlLmNvbSkKICogKGMpIE1lbWJlck1vdXNlLCBMTEMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqLwpjbGFzcyBNTV9NZW1iZXJNb3VzZVNlcnZpY2UKewoJcHVibGljIHN0YXRpYyAkU0VSVkVSSVAgPSBNTV9DRU5UUkFMX1NFUlZFUjsgCgoJcHJpdmF0ZSBzdGF0aWMgJENIRUNLSU5fRkFJTF9NQVhfQ09VTlQgPSAxMDsKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX0lOVEVSVkFMID0gNDsKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX1dBUk5JTkdfVEhSRVNIT0xEID0gNzsKCXB1YmxpYyBzdGF0aWMgJERFRkFVTFRfTUlOT1JfVkVSU0lPTiA9ICIxMDAiOwoJCglwdWJsaWMgc3RhdGljICRVU0FHRV9QQUlEX01FTUJFUlMgPSAidXNhZ2VfcGFpZF9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX0ZSRUVfTUVNQkVSUyA9ICJ1c2FnZV9mcmVlX21lbWJlcnMiOwoJcHVibGljIHN0YXRpYyAkVVNBR0VfUEFJRF9CVU5ETEVTID0gInVzYWdlX3BhaWRfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRVU0FHRV9GUkVFX0JVTkRMRVMgPSAidXNhZ2VfZnJlZV9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX09SREVSUyA9ICJ1c2FnZV9vcmRlcnMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX1BBWU1FTlRfTUVUSE9EUyA9ICJjb25maWdfcGF5bWVudF9tZXRob2RzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19NRU1CRVJTSElQU19GUkVFID0gImNvbmZpZ19mcmVlX21lbWJlcnNoaXBzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19NRU1CRVJTSElQU19QQUlEID0gImNvbmZpZ19wYWlkX21lbWJlcnNoaXBzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19CVU5ETEVTX0ZSRUUgPSAiY29uZmlnX2ZyZWVfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfQlVORExFU19QQUlEID0gImNvbmZpZ19wYWlkX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX1BST0RVQ1RTID0gImNvbmZpZ19wcm9kdWN0cyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTCA9ICJjb25maWdfZGZsdF9lbXBsb3llZV9lbWFpbCI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FID0gImNvbmZpZ19kZmx0X2VtcGxveWVlX25hbWUiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0NVUlJFTkNZID0gImNvbmZpZ19jdXJyZW5jeSI7CgkKCXB1YmxpYyBzdGF0aWMgJFBST1BTX1dQX1ZFUlNJT04gPSAid3BfdmVyc2lvbiI7CglwdWJsaWMgc3RhdGljICRQUk9QU19QSFBfVkVSU0lPTiA9ICJwaHBfdmVyc2lvbiI7CglwdWJsaWMgc3RhdGljICRQUk9QU19NTV9CRVRBID0gIm1tX2JldGEiOwoJCglwdWJsaWMgc3RhdGljICRNRVRIT0RfQVVUSE9SSVpFID0gImF1dGhvcml6ZVBsdWdpbiI7CglwdWJsaWMgc3RhdGljICRNRVRIT0RfQUNUSVZBVEUgPSAiYWN0aXZhdGVQbHVnaW4iOwoJcHVibGljIHN0YXRpYyAkTUVUSE9EX0RFQUNUSVZBVEUgPSAiZGVhY3RpdmF0ZVBsdWdpbiI7CglwdWJsaWMgc3RhdGljICRNRVRIT0RfUkVQT1JUX1NDSEVEVUxFX1NUQVRFID0gInJlcG9ydFNjaGVkdWxlU3RhdGUiOwoJCglwdWJsaWMgc3RhdGljICRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5UID0gIm1tLW9wdGlvbi1mYWlsZWQtY2hlY2tpbi1jb3VudCI7Cglwcml2YXRlIHN0YXRpYyAkQ0FDSEVEX0xJQ0VOU0VfT0JKID0gbnVsbDsKCXByaXZhdGUgc3RhdGljICRBVVRIX0xPQ0sgPSBmYWxzZTsKCXByaXZhdGUgc3RhdGljICRBVVRIX0xPQ0tfSURFTlRJRklFUiA9ICJtbS1hdXRob3JpemF0aW9uLWxvY2siOwoKCQoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHRoZSBwbHVnaW4gc2hvdWxkIGF1dGhvcml6ZSB3aXRoIE1NIGNlbnRyYWwKCSAqLwoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZG9BdXRob3JpemUoKQoJewoJCSRsb2NrU3RhdHVzID0gc2VsZjo6YWNxdWlyZVNlbWFwaG9yZSgpOwoJCWlmICgkbG9ja1N0YXR1cyA9PT0gMCkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmKCFwcmVnX21hdGNoKCIvKHBsdWdpbnNcLnBocCkvIiwgJF9TRVJWRVJbIlBIUF9TRUxGIl0pKQoJCXsKCQkJJGxhc3RDaGVja2luID0gYmFzZTY0X2RlY29kZShNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4pKTsKCQkJJG5leHRDaGVjayA9IHN0cnRvdGltZSgiKyIuc2VsZjo6JENIRUNLSU5fSU5URVJWQUwuIiBkYXkiLCBzdHJ0b3RpbWUoJGxhc3RDaGVja2luKSk7CgkJCSR0b2RheSA9IGRhdGUoIlktbS1kIGg6aTpzIik7IAoJCQlpZihzdHJ0b3RpbWUoJHRvZGF5KSA+PSAkbmV4dENoZWNrKQoJCQl7IAoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0gCgkJcmV0dXJuIGZhbHNlOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBoYXNTdXJwYXNzZWRGYWlsZWRUaHJlc2hvbGRNYXgoKQoJewoJCSRjbnQgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKHNlbGY6OiRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5UKTsKCQlpZihpc19udWxsKCRjbnQpIHx8IGVtcHR5KCRjbnQpKQoJCXsKCQkJJGNudCA9IDA7CgkJfQoJCWlmKCRjbnQ+PXNlbGY6OiRDSEVDS0lOX0ZBSUxfTUFYX0NPVU5UKQoJCXsgCgkJCXJldHVybiB0cnVlOwoJCX0gCgkJcmV0dXJuIGZhbHNlOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiB1cGRhdGVGYWlsZWRSZXF1ZXN0Q291bnQoKQoJewoJICAgIGdsb2JhbCAkd3BkYjsKCSAgICAKCSAgICBpZiAoIWlzX29iamVjdCgkd3BkYikpCgkgICAgewoJICAgICAgICByZXR1cm47IC8vZXJyb3IKCSAgICB9CgkgICAgCgkgICAgLy9hY3F1aXJlIHNlbWFwaG9yZQoJICAgICRpbnRlcm5hbExvY2tJRCA9ICJtbS1zZXJ2aWNlLWZhaWx1cmUtY2hlY2staW50ZXJuYWwiOwoJICAgICRsb2NrQWNxdWlyZWQgPSAkd3BkYi0+Z2V0X3Zhcigkd3BkYi0+cHJlcGFyZSgiU0VMRUNUIElGKElTX0ZSRUVfTE9DSyglcyksQ09BTEVTQ0UoR0VUX0xPQ0soJXMsMCksLTEpLDApIiwkaW50ZXJuYWxMb2NrSUQsJGludGVybmFsTG9ja0lEKSk7CgkgICAgaWYgKCRsb2NrQWNxdWlyZWQgPT0gIjEiKQoJICAgIHsgICAgCiAgICAgICAgCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sIGJhc2U2NF9lbmNvZGUoZGF0ZSgiWS1tLWQgaDppOnMiKSkpOwogICAgICAgIAkJJGNudCA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oc2VsZjo6JE9QVElPTl9LRVlfQ0hFQ0tJTl9GQUlMRURfQ09VTlQpOwogICAgICAgIAkJaWYoZW1wdHkoJGNudCkgfHwgIWlzX251bWVyaWMoJGNudCkpCiAgICAgICAgCQl7CiAgICAgICAgCQkJJGNudCA9IDA7CiAgICAgICAgCQl9CiAgICAgICAgCQkkY250Kys7CiAgICAgICAgCQkJCiAgICAgICAgCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKHNlbGY6OiRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5ULCAkY250KTsKICAgICAgICAJCWlmICgkY250ID4gc2VsZjo6JENIRUNLSU5fV0FSTklOR19USFJFU0hPTEQpCiAgICAgICAgCQl7CiAgICAgICAgCQkJc2VsZjo6c2VuZFdhcm5pbmdFbWFpbCgpOwogICAgICAgIAkJfQogICAgICAgIAkJLy9yZWxlYXNlIHNlbWFwaG9yZQogICAgICAgIAkJJHdwZGItPnF1ZXJ5KCR3cGRiLT5wcmVwYXJlKCJTRUxFQ1QgUkVMRUFTRV9MT0NLKCVzKSIsJGludGVybmFsTG9ja0lEKSk7CgkgICAgfQoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGF1dGhvcml6ZSgkcmVmcmVzaENsYXNzZXM9dHJ1ZSkKCXsKCQlpZiAoJHJlZnJlc2hDbGFzc2VzKQoJCXsKCQkJLy9jbGFzcyByZWZyZXNoIHJlcXVlc3RzIG1lYW5zIHRoZSBjYWxsIGlzIGNvbWluZyBmcm9tIGV4dGVybmFsLCBhdHRlbXB0IHRvIGFjcXVpcmUgdGhlIHNlbWFwaG9yZQoJCQlpZiAoKHNlbGY6OiRBVVRIX0xPQ0sgPT09IGZhbHNlKSAgJiYgKHNlbGY6OmFjcXVpcmVTZW1hcGhvcmUoKSA9PT0gMCkpCgkJCXsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJCSR1cmwgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCJzaXRldXJsIik7CgkJJHZlcnNpb24gPSBNZW1iZXJNb3VzZTo6Z2V0UGx1Z2luVmVyc2lvbigpOwoJCSRwb3N0dmFycyA9ICJ1cmw9Ii51cmxlbmNvZGUoJHVybCkuIiZ2ZXJzaW9uPSIuJHZlcnNpb247CgkJJG1pbm9yVmVyc2lvbiA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX01JTk9SX1ZFUlNJT04pOwoKCQlpZigkbWlub3JWZXJzaW9uICE9PSBmYWxzZSAmJiBpbnR2YWwoJG1pbm9yVmVyc2lvbikgPiAwKQoJCXsKCQkJJHBvc3R2YXJzIC49ICImbWlub3JfdmVyc2lvbj0iLiRtaW5vclZlcnNpb247CgkJfQoJCWVsc2UgCgkJewoJCQkkcG9zdHZhcnMgLj0gIiZtaW5vcl92ZXJzaW9uPSIuc2VsZjo6JERFRkFVTFRfTUlOT1JfVkVSU0lPTjsKCQl9CgkJCgkJaWYoY2xhc3NfZXhpc3RzKCJNTV9BcHBsaWVkQnVuZGxlIikpCgkJewoJCQkkcG9zdHZhcnMgLj0gIiZzdGF0aXN0aWNzPSIudXJsZW5jb2RlKGpzb25fZW5jb2RlKE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2VuZXJhdGVTdGF0aXN0aWNzKCkpKTsKCQl9CgkJCgkJJHBvc3R2YXJzIC49ICImcHJvcGVydGllcz0iLnVybGVuY29kZShqc29uX2VuY29kZShNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdlbmVyYXRlUHJvcGVydGllcygpKSk7CgkJCgkJJHBvc3R2YXJzIC49ICImZ2V0X2NsYXNzZXM9Ii4oJHJlZnJlc2hDbGFzc2VzID8gIjEiIDogIjAiKTsKCgkJJGpzb25fZGF0YSA9IHNlbGY6OnNlbmRSZXF1ZXN0KHNlbGY6OiRNRVRIT0RfQVVUSE9SSVpFLCAkcG9zdHZhcnMpOwovLyAJCXZhcl9kdW1wKCRqc29uX2RhdGEpOwovLyAJCWV4aXQ7CgkJaWYoJGpzb25fZGF0YSA9PT0gZmFsc2UpCgkJeyAgCgkJCXNlbGY6OnVwZGF0ZUZhaWxlZFJlcXVlc3RDb3VudCgpOwoJCQlpZiAoc2VsZjo6aGFzU3VycGFzc2VkRmFpbGVkVGhyZXNob2xkTWF4KCkpCgkJCXsKCQkJCWlmKE1NX1V0aWxzOjppc01lbWJlck1vdXNlQWN0aXZlKCkpCgkJCQl7CgkJCQkJc2VsZjo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWVsc2UgaWYoc2VsZjo6aXNVbmF1dGhvcml6ZWRSZXN1bHQoJGpzb25fZGF0YSkpCgkJewoJCQlpZihNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCQl7CgkJCQlzZWxmOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oc2VsZjo6JE9QVElPTl9LRVlfQ0hFQ0tJTl9GQUlMRURfQ09VTlQsIDApOwoJCSRqc29uID0gJGpzb25fZGF0YS0+cmVzcG9uc2VfZGF0YTsKCQkKCQlpZiAoJHJlZnJlc2hDbGFzc2VzICYmIHNlbGY6OiRBVVRIX0xPQ0spCgkJewoJCQlzZWxmOjpyZWxlYXNlU2VtYXBob3JlKCk7CgkJfQoJCXJldHVybiBzZWxmOjp1cGRhdGVMaWNlbnNlRGF0YSgkanNvbik7Cgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gYWN0aXZhdGVQbHVnaW4oKQoJewoJCSRwb3N0dmFycyA9ICJ1cmw9Ii5NTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCJzaXRldXJsIik7CgkJc2VsZjo6c2VuZFJlcXVlc3Qoc2VsZjo6JE1FVEhPRF9BQ1RJVkFURSwgJHBvc3R2YXJzKTsKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBkZWFjdGl2YXRlUGx1Z2luKCkKCXsKCQlnbG9iYWwgJHdwZGI7CgkJCgkJLy8gY2xlYXIgbGljZW5zZSBkYXRhCgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBLCAiIik7CgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTEFTVF9DSEVDS0lOLCAiIik7CgkJCgkJJHBvc3R2YXJzID0gInVybD0iLk1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oInNpdGV1cmwiKTsKCQlzZWxmOjpzZW5kUmVxdWVzdChzZWxmOjokTUVUSE9EX0RFQUNUSVZBVEUsICRwb3N0dmFycyk7CgkJCgkJJHNxbCA9ICJERUxFVEUgRlJPTSAiLk1NX1RBQkxFX0NPTlRBSU5FUjsKCQkkd3BkYi0+cXVlcnkoJHNxbCk7Cgl9CgkKCS8qKgoJICogVGhpcyBmdW5jdGlvbiBmb3JjZXMgYSBjaGVja2luCgkgKi8KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gcGluZygpCgl7CgkJLy8gY2hlY2sgaWYgTWVtYmVyTW91c2UgcGx1Z2luIGlzIGFjdGl2ZQoJCWlmKCFNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCXsKCQkJcmV0dXJuIG5ldyBNTV9SZXNwb25zZSgiTWVtYmVyTW91c2UgcGx1Z2luIGlzIGN1cnJlbnRseSBkZWFjdGl2YXRlZCIsIE1NX1Jlc3BvbnNlOjokRVJST1IpOwoJCX0KCQkKCQlyZXR1cm4gc2VsZjo6YXV0aG9yaXplKGZhbHNlKTsKCX0KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gdXBkYXRlTGljZW5zZURhdGEoJGpzb24pCgl7CgkJaWYoaXNzZXQoJGpzb24tPmlzVmFsaWQpKQoJCXsKCQkJaWYoaXNzZXQoJGpzb24tPmxpY2Vuc2VEYXRhKSkKCQkJeyAKCQkJCSRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoIiIsIGZhbHNlKTsKCQkJCSRsaWNlbnNlLT5zZXREYXRhKCRqc29uLT5saWNlbnNlRGF0YSk7CgoJCQkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTEFTVF9DSEVDS0lOLCBiYXNlNjRfZW5jb2RlKGRhdGUoIlktbS1kIGg6aTpzIikpKTsKCQkJCU1NX01lbWJlck1vdXNlU2VydmljZTo6c3RvcmVMaWNlbnNlKCRsaWNlbnNlKTsKCQkJfQoJCQkKCQkJaWYoIWVtcHR5KCRqc29uLT5jbGFzc2VzKSkKCQkJewkKCQkJCXNlbGY6OnNhdmVEeW5hbWljQ2xhc3NlcygkanNvbi0+Y2xhc3Nlcyk7CgkJCX0KCQkJCgkJCWlmKCFlbXB0eSgkanNvbi0+bm90aWZpY2F0aW9ucykgJiYgaXNfYXJyYXkoJGpzb24tPm5vdGlmaWNhdGlvbnMpKQoJCQl7CgkJCQlmb3JlYWNoKCRqc29uLT5ub3RpZmljYXRpb25zIGFzICRub3RpZmljYXRpb24pCgkJCQl7CgkJCQkJc3dpdGNoKCRub3RpZmljYXRpb24tPnR5cGUpCgkJCQkJewoJCQkJCQljYXNlICJtYWpvci12ZXJzaW9uLXVwZ3JhZGUiOgoJCQkJCQkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfVVBHUkFERV9OT1RJQ0UsICRub3RpZmljYXRpb24tPnZhbHVlKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQkJCgkJCQkJCWNhc2UgIm1pbm9yLXZlcnNpb24tdXBncmFkZSI6CiAgICAgICAgCQkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9NSU5PUl9WRVJTSU9OLCAkbm90aWZpY2F0aW9uLT52YWx1ZSk7CgkJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkKCQlyZXR1cm4gZmFsc2U7Cgl9CgkKCQoJLyoqIFVUSUxJVElFUyAqKi8KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gc2F2ZUR5bmFtaWNDbGFzc2VzKCRjbGFzc2VzKQoJewoJCWdsb2JhbCAkd3BkYjsKCQkKCQlpZihpc19vYmplY3QoJGNsYXNzZXMpIHx8IGlzX2FycmF5KCRjbGFzc2VzKSkKCQl7CgkJCSRzcWwgPSAiREVMRVRFIEZST00gIi5NTV9UQUJMRV9DT05UQUlORVIuIiBXSEVSRSBpc19zeXN0ZW09JzAnIjsKCQkJJHdwZGItPnF1ZXJ5KCRzcWwpOwoJCQkKCQkJZm9yZWFjaCgkY2xhc3NlcyBhcyAkY2xhc3NOYW1lPT4kY2xhc3NFbnRyeSkKCQkJewoJCQkJJHNxbCA9ICJJTlNFUlQgSU5UTyAiLk1NX1RBQkxFX0NPTlRBSU5FUi4iIFNFVCBuYW1lPSclcycsIG9iaj0nJXMnLCBkYXRlX2FkZGVkPU5PVygpIjsKCQkJCQoJCQkJaWYoc3RydG9sb3dlcigkY2xhc3NOYW1lKSA9PSAibWVtYmVybW91c2VzZXJ2aWNlIikKCQkJCXsKCQkJCQkkc3FsID0gIlVQREFURSAiLk1NX1RBQkxFX0NPTlRBSU5FUi4iIFNFVCBuYW1lPSclcycsIG9iaj0nJXMnLCBkYXRlX2FkZGVkPU5PVygpIHdoZXJlIG5hbWU9J21lbWJlcm1vdXNlc2VydmljZScgTElNSVQgMSI7CgkJCQl9CgkJCQkKCQkJCWlmKCR3cGRiLT5xdWVyeSgkd3BkYi0+cHJlcGFyZSgkc3FsLCAkY2xhc3NOYW1lLCAkY2xhc3NFbnRyeSkpKQoJCQkJewoJCQkJCSRjYWNoZVJlc3VsdCA9IHNlbGY6OmNhY2hlQ2xhc3MoJGNsYXNzTmFtZSwgJGNsYXNzRW50cnkpOwoJCQkJfQoJCQl9CgkJCQoJCQlNTV9TZXNzaW9uOjp2YWx1ZShNTV9TZXNzaW9uOjokS0VZX1VTSU5HX0RCX0NBQ0hFLCAhJGNhY2hlUmVzdWx0KTsKCQl9CgkJCgkJcmV0dXJuIHRydWU7Cgl9CgoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gY2FjaGVDbGFzcygkY2xhc3NOYW1lLCAkY2xhc3NFbnRyeSkKCXsKCQkkZmlsZVBhdGggPSBNTV9QTFVHSU5fQUJTUEFUSC4iL2NvbS9tZW1iZXJtb3VzZS9jYWNoZSI7CgkJCgkJaWYoaXNfZGlyKCRmaWxlUGF0aCkpCgkJewoJCQlpZihpc193cml0ZWFibGUoJGZpbGVQYXRoKSkKCQkJewoJCQkJaWYocHJlZ19tYXRjaCgiLyhtZW1iZXJtb3VzZV9zY2hlbWEpJC8iLCAkY2xhc3NOYW1lKSkKCQkJCXsKCQkJCQkkZmlsZVBhdGggLj0gIi8iLiRjbGFzc05hbWUuIi5zcWwiOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCSRmaWxlUGF0aCAuPSAiLyIuYmFzZTY0X2VuY29kZSgkY2xhc3NOYW1lKS4iLmNhY2hlIjsKCQkJCX0KCQkJCQoJCQkJJGZoID0gZm9wZW4oJGZpbGVQYXRoLCAndycpOwoJCQkJZndyaXRlKCRmaCwgJGNsYXNzRW50cnkpOwoJCQkJZmNsb3NlKCRmaCk7CgkJCQkKCQkJCWlmKGZpbGVfZXhpc3RzKCRmaWxlUGF0aCkpCgkJCQl7CgkJCQkJQGNobW9kKCRmaWxlUGF0aCwgMDc0NCk7CgkJCQl9CgkJCQkKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9IAoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBzZW5kUmVxdWVzdCgkbWV0aG9kLCAkcG9zdHZhcnMpCgl7CgkJJHVybCA9IHNlbGY6OiRTRVJWRVJJUC4kbWV0aG9kOwoJCQoJCSRyZXNwb25zZSA9IHdwX3JlbW90ZV9wb3N0KCR1cmwsIGFycmF5KCdtZXRob2QnID0+ICdQT1NUJywKCQkJCQkJCQkJCQkgICAndGltZW91dCcgPT4gNDUsCgkJCQkJCQkJCQkJICAgJ2JvZHknPT4kcG9zdHZhcnMpKTsKCQkgCgkJaWYgKGlzX3dwX2Vycm9yKCRyZXNwb25zZSkgfHwgKGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXSkgJiYgaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10pICYmICgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSAhPSAiMjAwIikpIHx8IAoJCQkJKCFpc3NldCgkcmVzcG9uc2VbJ2JvZHknXSkpICkgCgkJeyAKCQkJLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZWxzZSAKCQl7CgkJCSRqc29uID0ganNvbl9kZWNvZGUoJHJlc3BvbnNlWydib2R5J10pOwoJCQlpZighaXNfbnVsbCgkanNvbikgJiYgaXNzZXQoJGpzb24tPnJlc3BvbnNlX2RhdGEpKQoJCQl7CQoJCQkJJG9yaWdSZXNwb25zZSA9ICRqc29uLT5yZXNwb25zZV9kYXRhOwoJCQkJaWYoaXNfc3RyaW5nKCRqc29uLT5yZXNwb25zZV9kYXRhKSkKCQkJCXsKCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9IGpzb25fZGVjb2RlKCRqc29uLT5yZXNwb25zZV9kYXRhKTsKCQkJCQkJCgkJCQkJaWYoaXNfbnVsbCgkanNvbi0+cmVzcG9uc2VfZGF0YSkpCgkJCQkJewoJCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9ICRvcmlnUmVzcG9uc2U7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCS8vIHZhbGlkYXRlIGxpY2Vuc2UgZGF0YSBmb3IgYXV0aG9yaXphdGlvbnMKCQkJCWlmKCRtZXRob2QgPT0gc2VsZjo6JE1FVEhPRF9BVVRIT1JJWkUgJiYgKCFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEpIHx8ICFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEtPmlkKSkpCgkJCQl7CgkJCQkJJGVycm9yID0gbmV3IHN0ZENsYXNzKCk7CgkJCQkJJGVycm9yLT5yZXNwb25zZV9jb2RlID0gIjQwMSI7CgkJCQkJcmV0dXJuICRlcnJvcjsKCQkJCX0KCQkJCQoJCQkJcmV0dXJuICRqc29uOwoJCQl9CgkJCWVsc2UgCgkJCXsKCQkJCS8vIGxpY2Vuc2UgaXMgY2FuY2VsZWQKCQkJCSRlcnJvciA9IG5ldyBzdGRDbGFzcygpOwoJCQkJJGVycm9yLT5yZXNwb25zZV9jb2RlID0gIjQwMSI7CgkJCQlyZXR1cm4gJGVycm9yOwoJCQl9CgkJfQoJfQoJCgoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBpc1N1Y2Nlc3NmdWxSZXN1bHQoJHJlc3VsdCkKCXsgCgkJaWYoIWlzX251bGwoJHJlc3VsdCkgJiYgKCRyZXN1bHQtPnJlc3BvbnNlX2NvZGUgPT0gIjIwMCIpKQoJCXsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCgkJcmV0dXJuIGZhbHNlOwoJfQoJCgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gaXNVbmF1dGhvcml6ZWRSZXN1bHQoJHJlc3VsdCkKCXsKCQlpZiAoKCRyZXN1bHQgIT0gbnVsbCkgJiYgKGlzc2V0KCRyZXN1bHQtPnJlc3BvbnNlX2NvZGUpKSAmJiAoJHJlc3VsdC0+cmVzcG9uc2VfY29kZSA9PSAiNDAxIikpCgkJewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfQoJCgkKCS8qKiBTSVRFIFNUQVRTIEFORCBQUk9QRVJUSUVTICoqLwoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlU3RhdGlzdGljcygpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCSRzdGF0aXN0aWNzID0gYXJyYXkoc2VsZjo6JFVTQUdFX1BBSURfTUVNQkVSUyA9PiAwLAoJCQkJCQkJc2VsZjo6JFVTQUdFX0ZSRUVfTUVNQkVSUyA9PiAwLAoJCQkJCQkJc2VsZjo6JFVTQUdFX1BBSURfQlVORExFUyA9PiAwLAoJCQkJCQkJc2VsZjo6JFVTQUdFX0ZSRUVfQlVORExFUyA9PiAwLAoJCQkJCQkJc2VsZjo6JFVTQUdFX09SREVSUyA9PiAwLAoJCQkJCQkJc2VsZjo6JENPTkZJR19QQVlNRU5UX01FVEhPRFMgPT4gIiIsCgkJCQkJCQlzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX1BBSUQgPT4gMCwKCQkJCQkJCXNlbGY6OiRDT05GSUdfTUVNQkVSU0hJUFNfRlJFRSA9PiAwLAoJCQkJCQkJc2VsZjo6JENPTkZJR19CVU5ETEVTX1BBSUQgPT4gMCwKCQkJCQkJCXNlbGY6OiRDT05GSUdfQlVORExFU19GUkVFID0+IDAsCgkJCQkJCQlzZWxmOjokQ09ORklHX1BST0RVQ1RTID0+IDAsCgkJCQkJCQlzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfRU1BSUwgPT4gIiIsCgkJCQkJCQlzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRSAgPT4gIiIJCQkJCgkJKTsKCQkKCQkkY2hlY2tUYWJsZXNFeGlzdCA9ICR3cGRiLT5xdWVyeSgiU0hPVyBUQUJMRVMgTElLRSAnIi5NTV9UQUJMRV9VU0VSX0RBVEEuIiciKTsKCQlpZiAoJGNoZWNrVGFibGVzRXhpc3QgIT09IDApIC8vaWYgdGhlIHVzZXIgZGF0YSB0YWJsZSBkb2Vzbid0IGV4aXN0cywgd2UgYXJlIGluIHRoZSBpbnN0YWxsLCBkb24ndCB0cnkgdG8gZ2F0aGVyIHRoZSBvdGhlciBzdGF0aXN0aWNzCgkJewkJCgkJCS8vIFBBSUQgTUVNQkVSUyAoVVNBR0UpCgkJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudCh1LndwX3VzZXJfaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9VU0VSX0RBVEEuIiB1LCAiLk1NX1RBQkxFX01FTUJFUlNISVBfTEVWRUxTLiIgbSBXSEVSRSAiOwoJCQkkYmFzZVNxbCAuPSAidS5tZW1iZXJzaGlwX2xldmVsX2lkID0gbS5pZCBBTkQgKHUuc3RhdHVzID0gJyIuTU1fU3RhdHVzOjokQUNUSVZFLiInIE9SIHUuc3RhdHVzID0gJyIuTU1fU3RhdHVzOjokUEVORElOR19DQU5DRUxMQVRJT04uIicpICI7CgkJCQoJCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgbS5pc19mcmVlICE9ICcxJzsiKTsKCQkJCgkJCWlmKCRyZXN1bHQpCgkJCXsKCQkJCSRwYWlkTWVtYmVycyA9ICRyZXN1bHQtPnRvdGFsOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJHBhaWRNZW1iZXJzID0gMDsKCQkJfQoJCQkKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX1BBSURfTUVNQkVSU10gPSAkcGFpZE1lbWJlcnM7CgkJCQoJCQkvLyBGUkVFIE1FTUJFUlMgKFVTQUdFKQoJCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgbS5pc19mcmVlID0gJzEnOyIpOwoJCQkKCQkJaWYoJHJlc3VsdCkKCQkJewoJCQkJJGZyZWVNZW1iZXJzID0gJHJlc3VsdC0+dG90YWw7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkZnJlZU1lbWJlcnMgPSAwOwoJCQl9CgkJCQoJCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfRlJFRV9NRU1CRVJTXSA9ICRmcmVlTWVtYmVyczsKCQkJCgkJCS8vIFBBSUQgQlVORExFUyAoVVNBR0UpCgkJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudCgxKSBhcyB0b3RhbF9idW5kbGVzIEZST00gIi5NTV9UQUJMRV9BUFBMSUVEX0JVTkRMRVMuIiBhcHBCdW5kbGVzLCB7JHdwZGItPnVzZXJzfSB1c2VycywgIjsKCQkJJGJhc2VTcWwgLj0gTU1fVEFCTEVfQlVORExFUy4iIGJ1bmRsZXMgV0hFUkUgYXBwQnVuZGxlcy5hY2Nlc3NfdHlwZT0nIi5NTV9BcHBsaWVkQnVuZGxlOjokQUNDRVNTX1RZUEVfVVNFUi4iJyBBTkQgYXBwQnVuZGxlcy5hY2Nlc3NfdHlwZV9pZCA9IHVzZXJzLmlkICI7CgkJCSRiYXNlU3FsIC49ICJBTkQgKGFwcEJ1bmRsZXMuc3RhdHVzPSciLk1NX1N0YXR1czo6JEFDVElWRS4iJyBPUiBhcHBCdW5kbGVzLnN0YXR1cz0nIi5NTV9TdGF0dXM6OiRQRU5ESU5HX0NBTkNFTExBVElPTi4iJykgQU5EIGFwcEJ1bmRsZXMuYnVuZGxlX2lkID0gYnVuZGxlcy5pZCAiOwoJCQkKCQkJJHJlc3VsdCA9ICR3cGRiLT5nZXRfcm93KCRiYXNlU3FsLiIgQU5EIGJ1bmRsZXMuaXNfZnJlZSA9ICcwJzsiKTsKCQkJCgkJCWlmKCRyZXN1bHQpCgkJCXsKCQkJCSRwYWlkQnVuZGxlcyA9ICRyZXN1bHQtPnRvdGFsX2J1bmRsZXM7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkcGFpZEJ1bmRsZXMgPSAwOwoJCQl9CgkJCQoJCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfUEFJRF9CVU5ETEVTXSA9ICRwYWlkQnVuZGxlczsKCQkJCgkJCS8vIEZSRUUgQlVORExFUyAoVVNBR0UpCgkJCSRyZXN1bHQgPSAkd3BkYi0+Z2V0X3JvdygkYmFzZVNxbC4iIEFORCBidW5kbGVzLmlzX2ZyZWUgPSAnMSc7Iik7CgkJCQoJCQlpZigkcmVzdWx0KQoJCQl7CgkJCQkkZnJlZUJ1bmRsZXMgPSAkcmVzdWx0LT50b3RhbF9idW5kbGVzOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJGZyZWVCdW5kbGVzID0gMDsKCQkJfQoJCQkKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX0ZSRUVfQlVORExFU10gPSAkZnJlZUJ1bmRsZXM7CgkKCQkJLy8gT1JERVJTCgkJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudChvLmlkKSBhcyB0b3RhbCBGUk9NICIuTU1fVEFCTEVfT1JERVJTLiIgbyI7CgkJCQoJCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwpOwoJCQkKCQkJaWYoJHJlc3VsdCkKCQkJewoJCQkJJG9yZGVycyA9ICRyZXN1bHQtPnRvdGFsOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJG9yZGVycyA9IDA7CgkJCX0KCQkJCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRVU0FHRV9PUkRFUlNdID0gJG9yZGVyczsKCQkJCgkJCS8vIFBBWU1FTlQgTUVUSE9EUwoJCQkkcGF5bWVudE1ldGhvZHMgPSBhcnJheSgpOwoJCQkKCQkJJHNlcnZpY2VzID0gTU1fUGF5bWVudFNlcnZpY2VGYWN0b3J5OjpnZXRBdmFpbGFibGVQYXltZW50U2VydmljZXMoKTsKCQkJCQoJCQlmb3JlYWNoICgkc2VydmljZXMgYXMgJHNlcnZpY2UpCgkJCXsKCQkJCWlmICgkc2VydmljZSBpbnN0YW5jZW9mIE1NX1BheW1lbnRTZXJ2aWNlKQoJCQkJewoJCQkJCWFycmF5X3B1c2goJHBheW1lbnRNZXRob2RzLCAkc2VydmljZS0+Z2V0VG9rZW4oKSk7CgkJCQl9CgkJCX0KCQkJCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfUEFZTUVOVF9NRVRIT0RTXSA9IGpvaW4oIiwgIiwgJHBheW1lbnRNZXRob2RzKTsKCQkJCgkJCS8vIFBBSUQgTUVNQkVSU0hJUCBMRVZFTFMKCQkJJHBhaWRNZW1iZXJzaGlwcyA9IE1NX01lbWJlcnNoaXBMZXZlbDo6Z2V0TWVtYmVyc2hpcExldmVsc0xpc3QoZmFsc2UsIE1NX01lbWJlcnNoaXBMZXZlbDo6JFNVQl9UWVBFX1BBSUQpOwoJCQkKCQkJaWYoJHBhaWRNZW1iZXJzaGlwcyAmJiBpc19hcnJheSgkcGFpZE1lbWJlcnNoaXBzKSkKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IGNvdW50KCRwYWlkTWVtYmVyc2hpcHMpOwoJCQl9CgkJCWVsc2UgCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfTUVNQkVSU0hJUFNfUEFJRF0gPSAwOwoJCQl9CgkJCQoJCQkvLyBGUkVFIE1FTUJFUlNISVAgTEVWRUxTCgkJCSRmcmVlTWVtYmVyc2hpcHMgPSBNTV9NZW1iZXJzaGlwTGV2ZWw6OmdldE1lbWJlcnNoaXBMZXZlbHNMaXN0KGZhbHNlLCBNTV9NZW1iZXJzaGlwTGV2ZWw6OiRTVUJfVFlQRV9GUkVFKTsKCQkJCgkJCWlmKCRmcmVlTWVtYmVyc2hpcHMgJiYgaXNfYXJyYXkoJGZyZWVNZW1iZXJzaGlwcykpCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfTUVNQkVSU0hJUFNfRlJFRV0gPSBjb3VudCgkZnJlZU1lbWJlcnNoaXBzKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfTUVNQkVSU0hJUFNfRlJFRV0gPSAwOwoJCQl9CgkJCQoJCQkvLyBQQUlEIEJVTkRMRVMKCQkJJHBhaWRCdW5kbGVzID0gTU1fQnVuZGxlOjpnZXRCdW5kbGVzTGlzdChmYWxzZSwgTU1fQnVuZGxlOjokU1VCX1RZUEVfUEFJRCk7CgkJCQoJCQlpZigkcGFpZEJ1bmRsZXMgJiYgaXNfYXJyYXkoJHBhaWRCdW5kbGVzKSkKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19CVU5ETEVTX1BBSURdID0gY291bnQoJHBhaWRCdW5kbGVzKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfQlVORExFU19QQUlEXSA9IDA7CgkJCX0KCQkJCgkJCS8vIEZSRUUgQlVORExFUwoJCQkkZnJlZUJ1bmRsZXMgPSBNTV9CdW5kbGU6OmdldEJ1bmRsZXNMaXN0KGZhbHNlLCBNTV9CdW5kbGU6OiRTVUJfVFlQRV9GUkVFKTsKCQkJCgkJCWlmKCRmcmVlQnVuZGxlcyAmJiBpc19hcnJheSgkZnJlZUJ1bmRsZXMpKQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfRlJFRV0gPSBjb3VudCgkZnJlZUJ1bmRsZXMpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19CVU5ETEVTX0ZSRUVdID0gMDsKCQkJfQoJCQkKCQkJLy8gUFJPRFVDVFMKCQkJJHByb2R1Y3RzID0gTU1fUHJvZHVjdDo6Z2V0QWxsKCk7CgkJCQoJCQlpZigkcHJvZHVjdHMgJiYgaXNfYXJyYXkoJHByb2R1Y3RzKSkKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSBjb3VudCgkcHJvZHVjdHMpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSAwOwoJCQl9CgkJCQoJCQkvLyBERUZBVUxUIEVNUExPWUVFIEFDQ09VTlQKCQkJJGVtcGxveWVlID0gTU1fRW1wbG95ZWU6OmdldERlZmF1bHQoKTsKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19ERUZBVUxUX0VNUExPWUVFX0VNQUlMXSA9ICIiOwoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRV0gPSAiIjsKCQkJCgkJCWlmKCRlbXBsb3llZS0+aXNWYWxpZCgpKQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfRU1BSUxdID0gJGVtcGxveWVlLT5nZXRFbWFpbCgpOwoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19ERUZBVUxUX0VNUExPWUVFX05BTUVdID0gJGVtcGxveWVlLT5nZXREaXNwbGF5TmFtZSgpOwoJCQl9CgkJfQoJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfQ1VSUkVOQ1ldID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfQ1VSUkVOQ1kpOwoJCQoJCXJldHVybiAkc3RhdGlzdGljczsKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBnZW5lcmF0ZVByb3BlcnRpZXMoKQoJewoJCWdsb2JhbCAkd3BfdmVyc2lvbjsKCQkkcHJvcGVydGllcyA9IGFycmF5KCk7CgkJCgkJJHByb3BlcnRpZXNbc2VsZjo6JFBST1BTX1dQX1ZFUlNJT05dID0gJHdwX3ZlcnNpb247CgkJJHByb3BlcnRpZXNbc2VsZjo6JFBST1BTX1BIUF9WRVJTSU9OXSA9IHBocHZlcnNpb24oKTsKCgkJaWYoTU1fSVNfQkVUQSA9PSB0cnVlKQoJCXsKCQkJJHByb3BlcnRpZXNbc2VsZjo6JFBST1BTX01NX0JFVEFdID0gInRydWUiOwoJCX0KCQllbHNlCgkJewoJCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfTU1fQkVUQV0gPSAiZmFsc2UiOwoJCX0KCQkKCQlyZXR1cm4gJHByb3BlcnRpZXM7Cgl9CgkKCQoJLyoqIFBFUk1JU1NJT05TICoqLwoJCglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQVVUSE9SSVpFTkVUID0gInB5bXRfc2VydmljZV9hdXRob3JpemVuZXQiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0FVVEhPUklaRU5FVF9DSU0gPSAicHltdF9zZXJ2aWNlX2F1dGhvcml6ZW5ldF9jaW0iOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1BBWVBBTCA9ICJweW10X3NlcnZpY2VfcGF5cGFsIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9DTElDS0JBTksgPSAicHltdF9zZXJ2aWNlX2NsaWNrYmFuayI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQ0hBUkdJRlkgPSAicHltdF9zZXJ2aWNlX2NoYXJnaWZ5IjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9TVFJJUEUgPSAicHltdF9zZXJ2aWNlX3N0cmlwZSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQlJBSU5UUkVFID0gInB5bXRfc2VydmljZV9icmFpbnRyZWUiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0xJTUVMSUdIVCA9ICJweW10X3NlcnZpY2VfbGltZWxpZ2h0IjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9TVElDS1lJTyA9ICJweW10X3NlcnZpY2Vfc3RpY2t5aW8iOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0xJVExFID0gInB5bXRfc2VydmljZV9saXRsZSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQ09JTkJBU0UgPSAicHltdF9zZXJ2aWNlX2NvaW5iYXNlIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9UV09DSEVDS09VVCA9ICJweW10X3NlcnZpY2VfdHdvY2hlY2tvdXQiOwoJcHVibGljIHN0YXRpYyAkTUFYX05VTUJFUl9NRU1CRVJTID0gIm1heF9udW1iZXJfbWVtYmVycyI7CglwdWJsaWMgc3RhdGljICRTSE9XX01NX0ZPT1RFUiA9ICJzaG93X21tX2Zvb3RlciI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0JVTkRMRVMgPSAiZmVhdHVyZV9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfRFJJUF9DT05URU5UX1NDSEVEVUxFID0gImZlYXR1cmVfZHJpcF9jb250ZW50X3NjaGVkdWxlIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfUEhQX0lOVEVSRkFDRSA9ICJmZWF0dXJlX3BocF9pbnRlcmZhY2UiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9QVVNIX05PVElGSUNBVElPTlMgPSAiZmVhdHVyZV9wdXNoX25vdGlmaWNhdGlvbnMiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9BUEkgPSAiZmVhdHVyZV9hcGkiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9TTUFSVF9DT05URU5UX1RBR1MgPSAiZmVhdHVyZV9zbWFydF9jb250ZW50X3RhZ3MiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9BRkZJTElBVEVfTUdNVCA9ICJmZWF0dXJlX2FmZmlsaWF0ZV9tZ210IjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfTE9BRF9CQUxBTkNJTkcgPSAiZmVhdHVyZV9sb2FkX2JhbGFuY2luZyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0VNUExPWUVFX0FDQ09VTlRTID0gImZlYXR1cmVfZW1wbG95ZWVfYWNjb3VudHMiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9BRFZfU1VCU0NSSVBUSU9OX01HTVQgPSAiZmVhdHVyZV9hZHZfc3Vic2NyaXB0aW9uX21nbXQiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9SRVBPUlRJTkdfU1VJVEUgPSAiZmVhdHVyZV9yZXBvcnRpbmdfc3VpdGUiOwoJcHVibGljIHN0YXRpYyAkRVhURU5TSU9OX1VTRVJWT0lDRSA9ICJleHRlbnNpb25fdXNlcnZvaWNlIjsKCXB1YmxpYyBzdGF0aWMgJEVYVEVOU0lPTl9TT0NJQUxfTE9HSU4gPSAiZXh0ZW5zaW9uX3NvY2lhbF9sb2dpbiI7CglwdWJsaWMgc3RhdGljICRFWFRFTlNJT05fR09PR0xFX0VDT01NRVJDRSA9ICJleHRlbnNpb25fZ29vZ2xlX2Vjb21tZXJjZSI7CglwdWJsaWMgc3RhdGljICRTVVBQT1JUX0VNQUlMID0gInN1cHBvcnRfZW1haWwiOwoJcHVibGljIHN0YXRpYyAkU1VQUE9SVF9QSE9ORSA9ICJzdXBwb3J0X3Bob25lIjsKCXB1YmxpYyBzdGF0aWMgJFVOTElNSVRFRF9NRU1CRVJTID0gLTE7CgkKCXB1YmxpYyBzdGF0aWMgJEFDVElWRSA9IDE7CglwdWJsaWMgc3RhdGljICRJTkFDVElWRSA9IDA7CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gaGFzUGVybWlzc2lvbigka2V5KQoJewoJCSRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoKTsKCQkKCQlpZigkbGljZW5zZS0+aXNWYWxpZCgpKQoJCXsKCQkJJHBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7CgkJCQoJCQlpZigkcGVybWlzc2lvbnMpCgkJCXsKCQkJCSRwZXJtaXNzaW9ucyA9IGpzb25fZGVjb2RlKCRwZXJtaXNzaW9ucyk7CgkJCQkvKiogVEVTVElORyBQVVJQT1NFUyBPTkxZICoqLwoJCQkJaWYoJGtleSA9PSAicHltdF9zZXJ2aWNlX3R3b2NoZWNrb3V0IikKCQkJCXsKICAgICAgCQkJICAkcGVybWlzc2lvbnMtPiRrZXkgPSAxOwkKICAgICAgCQkgIH0KCQkJCQoJCQkJaWYoaXNfb2JqZWN0KCRwZXJtaXNzaW9ucykgJiYgaXNzZXQoJHBlcm1pc3Npb25zLT4ka2V5KSkKCQkJCXsKCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT4ka2V5OwoJCQkJfQoJCQl9CgkJCQoJCQlyZXR1cm4gc2VsZjo6JElOQUNUSVZFOwoJCX0KCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBnZXRNZW1iZXJMaW1pdCgpCgl7CgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOwoJCQoJCWlmKCRsaWNlbnNlLT5pc1ZhbGlkKCkpCgkJewoJCQkkcGVybWlzc2lvbnMgPSAkbGljZW5zZS0+Z2V0UGVybWlzc2lvbnMoKTsKCQkJCQoJCQlpZigkcGVybWlzc2lvbnMpCgkJCXsKCQkJCSRwZXJtaXNzaW9ucyA9IGpzb25fZGVjb2RlKCRwZXJtaXNzaW9ucyk7CgkJCQkKCQkJCWlmKGlzX29iamVjdCgkcGVybWlzc2lvbnMpICYmIGlzc2V0KCRwZXJtaXNzaW9ucy0+bWF4X251bWJlcl9tZW1iZXJzKSkKCQkJCXsKCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT5tYXhfbnVtYmVyX21lbWJlcnM7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIC0xOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldFVwZ3JhZGVVcmwoJGZlYXR1cmU9IiIpCgl7CgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOwoJCWlmKGVtcHR5KCRmZWF0dXJlKSkKCQl7CgkJCXN3aXRjaCgkbGljZW5zZS0+Z2V0cGVybWlzc2lvbnNQcm9maWxlSWQoKSkKCQkJewoJCQkJLy8gZnJlZQoJCQkJY2FzZSAxOgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wSzRFMTgiOwoKCQkJCS8vIHN0YXJ0ZXIgdjEKCQkJCWNhc2UgMjoKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cHc0MjM3IjsKCQkJCQoJCQkJLy8gZ3Jvd3RoIHYxCgkJCQljYXNlIDM6IAoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wdzQyMzciOwoJCQkJCgkJCQkvLyBwcm9mZXNzaW9uYWwgdjEKCQkJCWNhc2UgNDoKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cHZCUXRIIjsKCQkJCQkKCQkJCS8vIHN0YXJ0ZXIgdjIKCQkJCWNhc2UgNToKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cGpXYjhuIjsKCQkJCQkKCQkJCS8vIGJ1aWxkZXIgdjIKCQkJCWNhc2UgNjoKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cE5XeGtTIjsKCQkJCQkKCQkJCS8vIGdyb3d0aCB2MgoJCQkJY2FzZSA3OgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wdzQyMzciOwoJCQkJCQoJCQkJLy8gYWR2YW5jZWQgdjIKCQkJCWNhc2UgMTA6CgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXA0TnUxdSI7CgkJCQkJCgkJCQkvLyBwcmVtaXVtIHYyCgkJCQljYXNlIDg6CgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXB2QlF0SCI7CgkJCQkJCgkJCQkvLyBwcm9mZXNzaW9uYWwgdjIKCQkJCWNhc2UgOToKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cHZCUXRIIjsKCQkJCQkKCQkJCWRlZmF1bHQ6CgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXBLNEUxOCI7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJcmV0dXJuICJodHRwOi8vbWVtYmVybW91c2UuY29tL3VwZ3JhZGUucGhwP3Byb2ZpbGVpZD0iLiRsaWNlbnNlLT5nZXRwZXJtaXNzaW9uc1Byb2ZpbGVJZCgpLiImZmVhdHVyZT0iLiRmZWF0dXJlOwoJCX0KCX0KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKQoJewoJCS8vIGlmIGxvZ2dlZCBpbiBhcyBhbiBhZG1pbiBhbmQgaW4gdGhlIGFkbWluIGFyZWEsIGRpc2FibGUgdGhlIHBsdWdpbiB0aHJvdWdoIFdvcmRQcmVzcywgb3RoZXJ3aXNlCgkJLy8gbWFudWFsbHkgZGVhY3RpdmF0ZSB0aGUgcGx1Z2luIHRocm91Z2ggdGhlIGRhdGFiYXNlCgkJaWYoaXNfYWRtaW4oKSkKCQl7CgkJCWlmKCFwcmVnX21hdGNoKCIvKHBsdWdpbnNcLnBocCkvIiwgJF9TRVJWRVJbIlBIUF9TRUxGIl0pKQoJCQl7CgkJCQlNTV9EaWFnbm9zdGljTG9nOjpsb2coTU1fRGlhZ25vc3RpY0xvZzo6JE1NX0VSUk9SLCJwbHVnaW4gZGVhY3RpdmF0ZWQgZnJvbSBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uIik7CgkJCQloZWFkZXIoIkxvY2F0aW9uOiBwbHVnaW5zLnBocD8iLk1NX1Nlc3Npb246OiRQQVJBTV9DT01NQU5EX0RFQUNUSVZBVEUuIj0xJmRlYWN0aXZhdGU9dHJ1ZSIpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXNlbGY6Om1hbnVhbGx5RGVhY3RpdmF0ZVBsdWdpbigpOwoJCX0KCX0KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gbWFudWFsbHlEZWFjdGl2YXRlUGx1Z2luKCkKCXsKCQkkcGx1Z2lucyA9IGdldF9vcHRpb24oJ2FjdGl2ZV9wbHVnaW5zJyk7CgkKCQlpZihpc19hcnJheSgkcGx1Z2lucykgJiYgY291bnQoJHBsdWdpbnMpID4gMCkKCQl7CgkJCSRwbHVnaW5OYW1lID0gTU1fUExVR0lOX05BTUUuIi9pbmRleC5waHAiOwoJCQkka2V5ID0gYXJyYXlfc2VhcmNoKCRwbHVnaW5OYW1lLCAkcGx1Z2lucywgdHJ1ZSk7CgkJCQkKCQkJaWYoJGtleSAhPT0gZmFsc2UpCgkJCXsKCQkJCXVuc2V0KCRwbHVnaW5zWyRrZXldKTsKCQkJfQoJCQkJCgkJCXVwZGF0ZV9vcHRpb24oImFjdGl2ZV9wbHVnaW5zIiwgJHBsdWdpbnMpOwoJCQkKCQkJLy8gc2VuZCBhbiBlbWFpbCB0byB0aGUgZGVmYXVsdCBlbXBsb3llZQoJCQkkZW1wbG95ZWUgPSBNTV9FbXBsb3llZTo6Z2V0RGVmYXVsdCgpOwoJCQkkZW1haWwgPSBuZXcgTU1fRW1haWwoKTsKCQkJJGVtYWlsLT5zZXRDb250ZXh0KG5ldyBNTV9Db250ZXh0KCkpOwoJCQkkZW1haWwtPnNldFN1YmplY3QoIk1lbWJlck1vdXNlIGRlYWN0aXZhdGVkIG9uICIuZ2V0X29wdGlvbignc2l0ZXVybCcpKTsKCQkJJGVtYWlsLT5zZXRGcm9tTmFtZSgiTWVtYmVyTW91c2UgTm90aWZpY2F0aW9uIik7CgkJCSRlbWFpbC0+c2V0RnJvbUFkZHJlc3MoImRvLW5vdC1yZXBseUBtZW1iZXJtb3VzZS5jb20iKTsKCQkJJGVtYWlsLT5zZXRUb05hbWUoJGVtcGxveWVlLT5nZXRGaXJzdE5hbWUoKSk7CgkJCSRlbWFpbC0+c2V0VG9BZGRyZXNzKCRlbXBsb3llZS0+Z2V0RW1haWwoKSk7CgkJCQoJCQkkYm9keSA9ICJNZW1iZXJNb3VzZSBoYXMgYmVlbiBkZWFjdGl2YXRlZCBvbiAiLmdldF9vcHRpb24oJ3NpdGV1cmwnKS4iLlxuXG5UaGlzIGlzIG1vc3QgbGlrZWx5IGJlY2F1c2UgeW91ciBNZW1iZXJNb3VzZSBsaWNlbnNlIGhhcyBleHBpcmVkLlxuXG4iOwoJCQkkYm9keSAuPSAiSWYgeW91IHRoaW5rIHRoaXMgd2FzIGRvbmUgaW4gZXJyb3IsIHBsZWFzZSBjb250YWN0IHVzIGF0IHN1cHBvcnRAbWVtYmVybW91c2UuY29tLlxuXG5UaGFuayB5b3UsXG5NZW1iZXJNb3VzZSBTdXBwb3J0IFRlYW0iOwoJCQkkZW1haWwtPnNldEJvZHkoJGJvZHkpOwoJCQkKCQkJJGVtYWlsLT5zZW5kKCk7CgkJCQoJCQlNTV9EaWFnbm9zdGljTG9nOjpsb2coTU1fRGlhZ25vc3RpY0xvZzo6JE1NX0VSUk9SLCJwbHVnaW4gZGVhY3RpdmF0ZWQgZnJvbSBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6Om1hbnVhbGx5RGVhY3RpdmF0ZVBsdWdpbigpIik7CgkJCXNlbGY6OmRlYWN0aXZhdGVQbHVnaW4oKTsKCQl9Cgl9CgkKCQoJLyoqIExJQ0VOU0UgSEVMUEVSIE1FVEhPRFMgKiovCgkvKioKCSAqIFRoZSBmb2xsb3dpbmcgbWV0aG9kcyBhcmUgYXNzb2NpYXRlZCB3aXRoIGFuZCBjYWxsZWQgZnJvbSB0aGUgTU1fTGljZW5zZSBjbGFzcy4gVGhleSdyZSBwdXQgaGVyZSB0byBlbnN1cmUKCSAqIHRoZSBoaWdoZXN0IGxldmVsIG9mIHNlY3VyaXR5IGhvd2V2ZXIgdGhlIGFwcGxpY2F0aW9uIHNob3VsZG4ndCBpbnRlcmFjdCB3aXRoIHRoZW0gZGlyZWN0bHkgb24gdGhpcyBjbGFzcywKCSAqIHRoZXkgc2hvdWxkIHVzZSBNTV9MaWNlbnNlIGFzIHRoZSBtYWluIG9iamVjdCB0byBpbnRlcmZhY2Ugd2l0aC4KCSAqLwoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBnZXRMaWNlbnNlKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJLy9hdHRlbXB0IHRvIHJldHJpZXZlIGNhY2hlZCBsaWNlbnNlIG9iamVjdCBmcm9tIHByaXZhdGUgc3RhdGljIHZhcmlhYmxlLiBUaGlzIHByZXZlbnRzIHVubmVjZXNzYXJ5IGRiIGhpdCBhbmQgZGVjb2RpbmcKCQkkY2FjaGVkT2JqRXhpc3RzID0gKHNlbGY6OiRDQUNIRURfTElDRU5TRV9PQkogIT09IG51bGwpOwoJCQoJCWlmICghJGNhY2hlZE9iakV4aXN0cykKCQl7CgkJCS8vcmV0cmlldmUgY2FjaGVkIGxpY2Vuc2UgZGF0YSBmcm9tIG9wdGlvbgoJCQkkbGljZW5zZURhdGEgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX0RBVEEpOwoJCQlpZihlbXB0eSgkbGljZW5zZURhdGEpIHx8IE1NX01lbWJlck1vdXNlU2VydmljZTo6ZG9BdXRob3JpemUoKSkKCQkJewoJCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjphdXRob3JpemUoZmFsc2UpOwoJCQkJc2VsZjo6cmVsZWFzZVNlbWFwaG9yZSgpOwoJCQkJJGxpY2Vuc2VEYXRhID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBKTsKCQkJfQoJCQkKCQkJaWYoZW1wdHkoJGxpY2Vuc2VEYXRhKSAmJiBNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCQl7CgkJCQlNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJCgkJCS8vIHVub2JmdXNjYXRlIGxpY2Vuc2UgZGF0YQoJCQkkbGljZW5zZURhdGEgPSB1bnNlcmlhbGl6ZShiYXNlNjRfZGVjb2RlKCRsaWNlbnNlRGF0YSkpOwoJCQlpZiAoaXNfb2JqZWN0KCRsaWNlbnNlRGF0YSkpCgkJCXsKCQkJCXNlbGY6OiRDQUNIRURfTElDRU5TRV9PQkogPSAkbGljZW5zZURhdGE7CgkJCX0KCQl9CgkJZWxzZSAKCQl7CgkJCSRsaWNlbnNlRGF0YSA9IHNlbGY6OiRDQUNIRURfTElDRU5TRV9PQko7CgkJfQoJCgkJaWYoIWlzX251bGwoJGxpY2Vuc2VEYXRhKSAmJiBpc3NldCgkbGljZW5zZURhdGEtPmlkKSkKCQl7CgkJCSRsaWNlbnNlLT5zZXRJZCgkbGljZW5zZURhdGEtPmlkKTsKCQkJJGxpY2Vuc2UtPnNldE1lbWJlcklkKCRsaWNlbnNlRGF0YS0+bWVtYmVySWQpOwoJCQkkbGljZW5zZS0+c2V0TmFtZSgkbGljZW5zZURhdGEtPm5hbWUpOwoJCQkkbGljZW5zZS0+c2V0VXJsKCRsaWNlbnNlRGF0YS0+dXJsKTsKCQkJJGxpY2Vuc2UtPnNldEFwaUtleSgkbGljZW5zZURhdGEtPmFwaUtleSk7CgkJCSRsaWNlbnNlLT5zZXRBcGlTZWNyZXQoJGxpY2Vuc2VEYXRhLT5hcGlTZWNyZXQpOwoJCQkkbGljZW5zZS0+c2V0TWFqb3JWZXJzaW9uKCRsaWNlbnNlRGF0YS0+bWFqb3JWZXJzaW9uKTsKCQkJJGxpY2Vuc2UtPnNldE1pbm9yVmVyc2lvbigkbGljZW5zZURhdGEtPm1pbm9yVmVyc2lvbik7CgkJCSRsaWNlbnNlLT5zZXRQZXJtaXNzaW9uc1Byb2ZpbGVJZCgkbGljZW5zZURhdGEtPnBlcm1pc3Npb25zUHJvZmlsZUlkKTsKCQkJJGxpY2Vuc2UtPnNldFBlcm1pc3Npb25zKCRsaWNlbnNlRGF0YS0+cGVybWlzc2lvbnMpOwoJCQkkbGljZW5zZS0+c2V0U3RhdHVzKCRsaWNlbnNlRGF0YS0+c3RhdHVzKTsKCQkJJGxpY2Vuc2UtPnNldExhc3RVcGRhdGVkKCRsaWNlbnNlRGF0YS0+bGFzdFVwZGF0ZWQpOwoJCQkKCQkJaWYoaXNzZXQoJGxpY2Vuc2VEYXRhLT5pc1N0YWdpbmcpKQoJCQkJJGxpY2Vuc2UtPnNldEFzU3RhZ2luZygkbGljZW5zZURhdGEtPmlzU3RhZ2luZyk7CgkJCQoJCQkkbGljZW5zZS0+c2V0RGF0ZUFkZGVkKCRsaWNlbnNlRGF0YS0+ZGF0ZUFkZGVkKTsKCQkJJGxpY2Vuc2UtPnNldEF1dGhLZXkoYmFzZTY0X2VuY29kZShnZXRfb3B0aW9uKCJzaXRldXJsIikpKTsKCQkJJGxpY2Vuc2UtPnZhbGlkYXRlKCk7CgkJfSAKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBzdG9yZUxpY2Vuc2UoTU1fTGljZW5zZSAkbGljZW5zZSkKCXsKCQkkbGljZW5zZURhdGEgPSBiYXNlNjRfZW5jb2RlKHNlcmlhbGl6ZShzZWxmOjpwYWNrYWdlVXBMaWNlbnNlRGF0YSgkbGljZW5zZSkpKTsKCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX0RBVEEsICRsaWNlbnNlRGF0YSk7Cgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gdmFsaWRhdGVMaWNlbnNlKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJJGF1dGhLZXkgPSBiYXNlNjRfZGVjb2RlKCRsaWNlbnNlLT5nZXRBdXRoS2V5KCkpOwoJCQoJCWlmKGVtcHR5KCRhdXRoS2V5KSB8fCAoJGF1dGhLZXkgIT0gZ2V0X29wdGlvbigic2l0ZXVybCIpKSkKCQl7CgkJCXNlbGY6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9CgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHBhY2thZ2VVcExpY2Vuc2VEYXRhKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJJGRhdGEgPSBuZXcgc3RkQ2xhc3MoKTsKCQoJCSRkYXRhLT5pZCA9ICRsaWNlbnNlLT5nZXRJZCgpOwoJCSRkYXRhLT5tZW1iZXJJZCA9ICRsaWNlbnNlLT5nZXRNZW1iZXJJZCgpOwoJCSRkYXRhLT5uYW1lID0gJGxpY2Vuc2UtPmdldE5hbWUoKTsKCQkkZGF0YS0+dXJsID0gJGxpY2Vuc2UtPmdldFVybCgpOwoJCSRkYXRhLT5hcGlLZXkgPSAkbGljZW5zZS0+Z2V0QXBpS2V5KCk7CgkJJGRhdGEtPmFwaVNlY3JldCA9ICRsaWNlbnNlLT5nZXRBcGlTZWNyZXQoKTsKCQkkZGF0YS0+bWFqb3JWZXJzaW9uID0gJGxpY2Vuc2UtPmdldE1ham9yVmVyc2lvbigpOwoJCSRkYXRhLT5taW5vclZlcnNpb24gPSAkbGljZW5zZS0+Z2V0TWlub3JWZXJzaW9uKCk7CgkJJGRhdGEtPnBlcm1pc3Npb25zUHJvZmlsZUlkID0gJGxpY2Vuc2UtPmdldHBlcm1pc3Npb25zUHJvZmlsZUlkKCk7CgkJJGRhdGEtPnBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7CgkJJGRhdGEtPnN0YXR1cyA9ICRsaWNlbnNlLT5nZXRTdGF0dXMoKTsKCQkkZGF0YS0+aXNBcmNoaXZlZEZsYWcgPSAkbGljZW5zZS0+aXNBcmNoaXZlZCgpOwoJCSRkYXRhLT5pc1N0YWdpbmcgPSAkbGljZW5zZS0+aXNTdGFnaW5nKCk7CgkJJGRhdGEtPmxhc3RVcGRhdGVkID0gJGxpY2Vuc2UtPmdldExhc3RVcGRhdGVkKCk7CgkJJGRhdGEtPmRhdGVBZGRlZCA9ICRsaWNlbnNlLT5nZXREYXRlQWRkZWQoKTsKCQoJCXJldHVybiAkZGF0YTsKCX0KCQoJCgkvKiogUFJPVEVDVEVEIFVUSUxJVEVTICoqLwoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBlbmNyeXB0UGFzc3dvcmQoJHBhc3N3b3JkKQoJewoJCWZvcigkaT0wOyAkaTw1OyAkaSsrKQoJCXsKCQkJJHBhc3N3b3JkID0gc3RycmV2KGJhc2U2NF9lbmNvZGUoJHBhc3N3b3JkKSk7CgkJfQoJCQkKCQlyZXR1cm4gJHBhc3N3b3JkOwoJfQoKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZGVjcnlwdFBhc3N3b3JkKCRwYXNzd29yZCkKCXsKCQlmb3IoJGk9MDsgJGk8NTsgJGkrKykKCQl7CgkJCSRwYXNzd29yZCA9IGJhc2U2NF9kZWNvZGUoc3RycmV2KCRwYXNzd29yZCkpOwoJCX0KCgkJcmV0dXJuICRwYXNzd29yZDsKCX0KCQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIHJlZ3VsYXRlU2NoZWR1bGluZ0VudHJpZXMoKQoJewoJICAgIGdsb2JhbCAkd3BkYjsKCSAgICAKCQkkbG9ja05hbWUgPSBzdWJzdHIoInskd3BkYi0+cHJlZml4fS1tbS1zY2hlZHVsaW5nLXJlZ3VsYXRvciIsMCw2Myk7IC8vb3B0aW9uIGFuZCBsb2NrIGlkZW50aWZpZXIgYXJlIHRoZSBzYW1lCgkJJGRhdGFPcHRpb25OYW1lID0gc3Vic3RyKCJ7JHdwZGItPnByZWZpeH1tbS1zY2hyZWctZGF0YSIsMCw2Myk7CgkJJG1ldGhvZCA9ICJyZXBvcnREdXBsaWNhdGVTY2hlZHVsZXMiOwoJICAgICR1cmwgPSBzZWxmOjokU0VSVkVSSVAuJG1ldGhvZDsKCSAgICAKCSAgICAkb3B0aW9uVmFsdWUgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCRsb2NrTmFtZSk7CgkgICAgCgkgICAgaWYgKCRvcHRpb25WYWx1ZSA9PSBmYWxzZSkKCSAgICB7CgkgICAgICAgIAoJICAgICAgICAkbG9ja0FjcXVpcmVkID0gJHdwZGItPmdldF92YXIoIlNFTEVDVCBDT0FMRVNDRShHRVRfTE9DSygneyRsb2NrTmFtZX0nLDApLDApIik7CgkgICAgICAgIAoJICAgICAgICBpZiAoJGxvY2tBY3F1aXJlZCA9PSAxKSAvL2JlZ2luIGxvY2tlZCBzZWN0aW9uCgkgICAgICAgIHsKCSAgICAgICAgICAgIC8vc2V0IHRpbWUgbGltaXQgdG8gaW5maW5pdGUKCSAgICAgICAgICAgIHNldF90aW1lX2xpbWl0KDApOwoJICAgICAgICAgICAgCgkgICAgICAgICAgICAvL3VzZWQgbGF0ZXIgdG8gZGV0ZXJtaW5lIGhvdyB0byBhY3QgaW4gdGhlIGV2ZW50IG9mIHRyYW5zbWlzc2lvbiBlcnJvcnMKCSAgICAgICAgICAgICRzdG9yZUZvckxhdGVyID0gZmFsc2U7CgkgICAgICAgICAgICAKCSAgICAgICAgICAgICRzZVRhYmxlID0gTU1fVEFCTEVfU0NIRURVTEVEX0VWRU5UUzsKCSAgICAgICAgICAgICRzcFRhYmxlID0gTU1fVEFCTEVfU0NIRURVTEVEX1BBWU1FTlRTOwoJICAgICAgICAgICAgCgkgICAgICAgICAgICAvL3JldHJpZXZlIHVzZXIgaWQsIG9yZGVyIGlkLCBvcmRlciBudW1iZXIsIGhvdyBtYW55IGZ1dHVyZSBzY2hlZHVsZWQgZXZlbnRzIHRoZXJlIGFyZSwgYW5kIGEgbGlzdCBvZiBldmVudCBpZHMKCSAgICAgICAgICAgIC8vZm9yIGV2ZXJ5IG9yZGVyIGl0ZW0gdGhhdCBoYXMgbW9yZSB0aGFuIG9uZSB1bnByb2Nlc3NlZCAod2UgY2FuIGFzc3VtZSBmdXR1cmUpIHNjaGVkdWxlZCBldmVudAoJICAgICAgICAgICAgLy90aGVzZSB2aW9sYXRlIHRoZSBjb25zdHJhaW50IHRoYXQgZXZlcnkgb3JkZXIgaXRlbSBoYXMgYXQgbW9zdCBvbmUgZnV0dXJlIHNjaGVkdWxlZCBwYXltZW50IGV2ZW50CgkgICAgICAgICAgICAkc3FsID0gIlNFTEVDVCBBLnNjaGVkdWxlX2lkcywgQS5vcmRlcl9pdGVtX2lkLCBBLmZyZXEsIG8uaWQgQVMgb3JkZXJfaWQsIG8ub3JkZXJfbnVtYmVyLCBvLnVzZXJfaWQgRlJPTSAiLgoJICAgICAgICAgICAgIihTRUxFQ1QgZ3JvdXBfY29uY2F0KHNlLmlkKSBBUyBzY2hlZHVsZV9pZHMsIHNwLm9yZGVyX2l0ZW1faWQsIENPVU5UKDEpIEFTIGZyZXEgRlJPTSB7JHNlVGFibGV9IHNlIElOTkVSIEpPSU4geyRzcFRhYmxlfSBzcCAiLgoJICAgICAgICAgICAgIk9OIChzZS5pZCA9IHNwLmlkKSBXSEVSRSAoc2UucHJvY2Vzc2VkX2RhdGUgSVMgTlVMTCkgR1JPVVAgQlkgc3Aub3JkZXJfaXRlbV9pZCBIQVZJTkcgZnJlcSA+IDEpIEFTIEEgIi4KCSAgICAgICAgICAgICJJTk5FUiBKT0lOIG1tX29yZGVyX2l0ZW1zIG9pIE9OIChBLm9yZGVyX2l0ZW1faWQgPSBvaS5pZCkgSU5ORVIgSk9JTiBtbV9vcmRlcnMgbyBPTiAob2kub3JkZXJfaWQgPSBvLmlkKSI7CgkgICAgICAgICAgICAkb2NjdXJyZW5jZXMgPSAkd3BkYi0+Z2V0X3Jlc3VsdHMoJHNxbCk7CgkgICAgICAgICAgICAKCSAgICAgICAgICAgIGlmIChjb3VudCgkb2NjdXJyZW5jZXMpID4gMCkKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAkbGljZW5zZSA9IG5ldyBNTV9MaWNlbnNlKCIiLGZhbHNlKTsKCSAgICAgICAgICAgICAgICBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdldExpY2Vuc2UoJGxpY2Vuc2UpOwoJICAgICAgICAgICAgICAgICRwYWNrYWdlZERhdGEgPSBhcnJheSgiYXBpX2tleSIgICAgICAgPT4gJGxpY2Vuc2UtPmdldEFwaUtleSgpLAoJICAgICAgICAgICAgICAgICAgICAiYXBpX3NlY3JldCIgICAgID0+ICRsaWNlbnNlLT5nZXRBcGlTZWNyZXQoKSwKCSAgICAgICAgICAgICAgICAgICAgImNvbW1hbmQiCQkgID0+ICJyZXBvcnREdXBsaWNhdGVTY2hlZHVsZXMiLAoJICAgICAgICAgICAgICAgICAgICAiZGF0YSIgCSAgICAgID0+ICRvY2N1cnJlbmNlcwoJICAgICAgICAgICAgICAgICk7CgkgICAgICAgICAgICAgICAgCgkgICAgICAgICAgICAgICAgLy9zZW5kIHBhY2thZ2VkIGRhdGEgdG8gY2VudHJhbAoJICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgICRyZXNwb25zZSA9IHdwX3JlbW90ZV9wb3N0KCR1cmwsIGFycmF5KCdtZXRob2QnID0+ICdQT1NUJywKCSAgICAgICAgICAgICAgICAgICAgJ3RpbWVvdXQnID0+IDEyMCwKCSAgICAgICAgICAgICAgICAgICAgJ2JvZHknPT4kcGFja2FnZWREYXRhKSk7CgkgICAgICAgICAgICAgICAgCgkgICAgICAgICAgICAgICAgaWYgKGlzX3dwX2Vycm9yKCRyZXNwb25zZSkgfHwgKGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXSkgJiYgaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10pICYmICgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSAhPSAiMjAwIikpIHx8CgkgICAgICAgICAgICAgICAgICAgICghaXNzZXQoJHJlc3BvbnNlWydib2R5J10pKSApCgkgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAvLyB1bmFibGUgdG8gY29ubmVjdCB0byBzZXJ2ZXIKCSAgICAgICAgICAgICAgICAgICAgJHN0b3JlRm9yTGF0ZXIgPSB0cnVlOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAkanNvbiA9IGpzb25fZGVjb2RlKCRyZXNwb25zZVsnYm9keSddKTsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFpc3NldCgkanNvbi0+cmVzcG9uc2VfY29kZSkgfHwgKCRqc29uLT5yZXNwb25zZV9jb2RlICE9ICIyMDAiKSkKCSAgICAgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICAgICAgJHN0b3JlRm9yTGF0ZXIgPSB0cnVlOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgIGlmICgkc3RvcmVGb3JMYXRlcikKCSAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9vcHRpb24oJGRhdGFPcHRpb25OYW1lLCRvY2N1cnJlbmNlcyx0cnVlKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgCgkgICAgICAgICAgICAgICAgLy9ub3cgcmVtb3ZlIGR1cGxpY2F0ZWQgc2NoZWR1bGVzCgkgICAgICAgICAgICAgICAgZm9yZWFjaCAoJG9jY3VycmVuY2VzIGFzICRvY2N1cnJlbmNlKQoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRvY2N1cnJlbmNlLT5zY2hlZHVsZV9pZHMpICYmIChzdHJwb3MoJG9jY3VycmVuY2UtPnNjaGVkdWxlX2lkcywiLCIpICE9PSBmYWxzZSkpCgkgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIC8vcmVtb3ZlIHRoZSBmaXJzdCBpZCwgZGVsZXRlIHRoZSByZW1haW5pbmcgaWRzCgkgICAgICAgICAgICAgICAgICAgICAgICAkcmVtYWluaW5nU2NoZWR1bGVzID0gc3Vic3RyKCRvY2N1cnJlbmNlLT5zY2hlZHVsZV9pZHMsc3RycG9zKCRvY2N1cnJlbmNlLT5zY2hlZHVsZV9pZHMsIiwiKSsxKTsKCSAgICAgICAgICAgICAgICAgICAgICAgICRkZWxldGVRdWVyeUEgPSAiREVMRVRFIEZST00geyRzZVRhYmxlfSBXSEVSRSAocHJvY2Vzc2VkX2RhdGUgSVMgTlVMTCkgQU5EIGlkIElOICh7JHJlbWFpbmluZ1NjaGVkdWxlc30pIjsKCSAgICAgICAgICAgICAgICAgICAgICAgICR3cGRiLT5xdWVyeSgkZGVsZXRlUXVlcnlBKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAKCSAgICAgICAgICAgICAgICAkZGVsZXRlUXVlcnlCID0gIkRFTEVURSBzcCBGUk9NIHskc3BUYWJsZX0gc3AgTEVGVCBKT0lOIHskc2VUYWJsZX0gc2UgT04gKHNlLmlkID0gc3AuaWQpIFdIRVJFIHNlLmlkIElTIE5VTEwiOwoJICAgICAgICAgICAgICAgICR3cGRiLT5xdWVyeSgkZGVsZXRlUXVlcnlCKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIAoJICAgICAgICAgICAgLy9zZXQgdGhlIG9wdGlvbiBzbyB0aGlzIGRvZXNuJ3QgcnVuIGFnYWluCgkgICAgICAgICAgICBpZiAoJHN0b3JlRm9yTGF0ZXIpCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsInBlbmRpbmciLHRydWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgIHVwZGF0ZV9vcHRpb24oJGxvY2tOYW1lLCJjb21wbGV0ZWQiLHRydWUpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgCgkgICAgICAgICAgICAvL2VuZCBsb2NrZWQgc2VjdGlvbgoJICAgICAgICAgICAgJHdwZGItPnF1ZXJ5KCJTRUxFQ1QgUkVMRUFTRV9MT0NLKCd7JGxvY2tOYW1lfScpIik7CgkgICAgICAgIH0KCSAgICB9CgkgICAgZWxzZSBpZiAoJG9wdGlvblZhbHVlID09ICJwZW5kaW5nIikKCSAgICB7CgkgICAgICAgICRkYXRhT3B0aW9uVmFsdWUgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCRkYXRhT3B0aW9uTmFtZSk7CgkgICAgICAgIGlmICgkZGF0YU9wdGlvblZhbHVlICE9PSBmYWxzZSkKCSAgICAgICAgewoJICAgICAgICAgICAgLy90aGUgc2NoZWR1bGluZyByZWd1bGF0b3IgY29tcGxldGVkLCBidXQgdGhlcmUgd2FzIHByZXZpb3VzbHkgYW4gaXNzdWUgc2VuZGluZyB0aGUgZGF0YSB0byBjZW50cmFsLCB0cnkgYWdhaW4KCSAgICAgICAgICAgICRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoIiIsZmFsc2UpOwoJICAgICAgICAgICAgTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZXRMaWNlbnNlKCRsaWNlbnNlKTsKCSAgICAgICAgICAgIAoJICAgICAgICAgICAgJHBhY2thZ2VkRGF0YSA9IGFycmF5KCJhcGlfa2V5IiAgICAgICA9PiAkbGljZW5zZS0+Z2V0QXBpS2V5KCksCgkgICAgICAgICAgICAgICAgImFwaV9zZWNyZXQiICAgID0+ICRsaWNlbnNlLT5nZXRBcGlTZWNyZXQoKSwKCSAgICAgICAgICAgICAgICAiY29tbWFuZCIJCSAgPT4gInJlcG9ydER1cGxpY2F0ZVNjaGVkdWxlcyIsCgkgICAgICAgICAgICAgICAgImRhdGEiIAkgICAgICA9PiAkZGF0YU9wdGlvblZhbHVlCgkgICAgICAgICAgICApOwoJICAgICAgICAgICAgCgkgICAgICAgICAgICAkcmVzcG9uc2UgPSB3cF9yZW1vdGVfcG9zdCgkdXJsLCBhcnJheSgnbWV0aG9kJyA9PiAnUE9TVCcsCgkgICAgICAgICAgICAgICAgJ3RpbWVvdXQnID0+IDEyMCwKCSAgICAgICAgICAgICAgICAnYm9keSc9PiRwYWNrYWdlZERhdGEpKTsKCSAgICAgICAgICAgIAoJICAgICAgICAgICAgaWYgKGlzX3dwX2Vycm9yKCRyZXNwb25zZSkgfHwgKGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXSkgJiYgaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10pICYmICgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSAhPSAiMjAwIikpIHx8CgkgICAgICAgICAgICAgICAgKCFpc3NldCgkcmVzcG9uc2VbJ2JvZHknXSkpICkKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAvLyB1bmFibGUgdG8gY29ubmVjdCB0byBzZXJ2ZXIKCSAgICAgICAgICAgICAgICB1cGRhdGVfb3B0aW9uKCRsb2NrTmFtZSwiY29tcGxldGVkIix0cnVlKTsgLy9zZXQgb3B0aW9uIHRvIGNvbXBsZXRlZCwgYnV0IGxlYXZlIHRoZSBkYXRhIHNvIGl0IGNhbiBwb3RlbnRpYWxseSBiZSByZXRyaWV2ZWQgbGF0ZXIKCSAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBlbHNlCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgJGpzb24gPSBqc29uX2RlY29kZSgkcmVzcG9uc2VbJ2JvZHknXSk7CgkgICAgICAgICAgICAgICAgaWYgKGlzc2V0KCRqc29uLT5yZXNwb25zZV9jb2RlKSAmJiAoJGpzb24tPnJlc3BvbnNlX2NvZGUgPT0gIjIwMCIpKQoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgZGVsZXRlX29wdGlvbigkZGF0YU9wdGlvbk5hbWUpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoJICAgICAgICAvL3JlZ2FyZGxlc3Mgb2Ygb3V0Y29tZSwgc2V0IHBhdGNoIGFzIGNvbXBsZXRlZAoJICAgICAgICB1cGRhdGVfb3B0aW9uKCRsb2NrTmFtZSwiY29tcGxldGVkIix0cnVlKTsKCSAgICB9CgkgICAgCgl9CgkKCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiByZWdpc3Rlck9ycGhhbmVkU2NoZWR1bGVzKCkKCXsKCSAgICAKICAgICAgICBnbG9iYWwgJHdwZGI7CgkgICAgCgkgICAgJGxvY2tOYW1lID0gc3Vic3RyKCJ7JHdwZGItPnByZWZpeH1tbS11bnJlZy1zY2hlZHVsZXMtdXBkYXRlIiwwLDYzKTsgLy9vcHRpb24gYW5kIGxvY2sgaWRlbnRpZmllciBhcmUgdGhlIHNhbWUKCSAgICAkZGF0YU9wdGlvbk5hbWUgPSBzdWJzdHIoInskd3BkYi0+cHJlZml4fW1tLXVucmVnc2NoZWQtZGF0YSIsMCw2Myk7CgkgICAgJG1ldGhvZCA9ICJyZXBvcnRVbnJlZ2lzdGVyZWRTY2hlZHVsZXMiOwoJICAgICR1cmwgPSBzZWxmOjokU0VSVkVSSVAuJG1ldGhvZDsKCSAgICAKICAgICAgICAkbG9ja0FjcXVpcmVkID0gJHdwZGItPmdldF92YXIoIlNFTEVDVCBDT0FMRVNDRShHRVRfTE9DSygneyRsb2NrTmFtZX0nLDApLDApIik7ICAgIAogICAgICAgIGlmICgkbG9ja0FjcXVpcmVkID09IDEpIC8vYmVnaW4gbG9ja2VkIHNlY3Rpb24KICAgICAgICB7CiAgICAgICAgICAgICRzZVRhYmxlID0gTU1fVEFCTEVfU0NIRURVTEVEX0VWRU5UUzsKICAgICAgICAgICAgJHNwVGFibGUgPSBNTV9UQUJMRV9TQ0hFRFVMRURfUEFZTUVOVFM7CiAgICAgICAgICAgICRvaVRhYmxlID0gTU1fVEFCTEVfT1JERVJfSVRFTVM7CiAgICAgICAgICAgICRvVGFibGUgID0gTU1fVEFCTEVfT1JERVJTOwogICAgICAgICAgICAkc2FmZURhdGUgPSBkYXRlKCJZLW0tZCBIOmkiLHN0cnRvdGltZSgiLTI0IEhvdXJzIikpOwogICAgICAgICAgICAkb3B0aW9uVmFsdWUgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCRsb2NrTmFtZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkc3FsSGVhZCA9ICJTRUxFQ1Qgc2UuaWQgQVMgZXZlbnRfaWQsIGNvbmNhdChvLnVzZXJfaWQsJyMnLG8ub3JkZXJfbnVtYmVyKSBBUyByZWNvcmQgIjsKICAgICAgICAgICAgJHNxbEJvZHkgPSAiRlJPTSB7JHNwVGFibGV9IHNwIElOTkVSIEpPSU4geyRzZVRhYmxlfSBzZSBPTiAoc3AuaWQgPSBzZS5pZCkgIi4KICAgICAgICAgICAgICAgICJJTk5FUiBKT0lOIHskb2lUYWJsZX0gb2kgT04gKHNwLm9yZGVyX2l0ZW1faWQgPSBvaS5pZCkgIi4KICAgICAgICAgICAgICAgICJJTk5FUiBKT0lOIHskb1RhYmxlfSBvIE9OIChvaS5vcmRlcl9pZCA9IG8uaWQpICIuCiAgICAgICAgICAgICAgICAiTEVGVCBKT0lOIG1tX3F1ZXVlZF9zY2hlZHVsZWRfZXZlbnRzIHEgb24gKHNlLmlkID0gcS5ldmVudF9pZCkgIi4KICAgICAgICAgICAgICAgICJXSEVSRSAoc2Uuc2NoZWR1bGVkX2RhdGUgPCAneyRzYWZlRGF0ZX0nKSBBTkQgKHNlLnN0YXR1cyA9IDApIEFORCAoc2UucHJvY2Vzc2VkX2RhdGUgSVMgTlVMTCkgQU5EIChvaS5zdGF0dXMgPSAxKSBBTkQgKHEuZXZlbnRfaWQgSVMgTlVMTCkiOwogICAgICAgICAgICAKICAgICAgICAgICAgLy9zZXQgdGltZSBsaW1pdCB0byBpbmZpbml0ZQogICAgICAgICAgICBzZXRfdGltZV9saW1pdCgwKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICgkb3B0aW9uVmFsdWUgPT0gZmFsc2UpIC8vbmV2ZXIgYmVlbiBzZXQKICAgICAgICAgICAgeyAKICAgICAgICAgICAgICAgIC8vdXNlZCBsYXRlciB0byBkZXRlcm1pbmUgaG93IHRvIGFjdCBpbiB0aGUgZXZlbnQgb2YgdHJhbnNtaXNzaW9uIGVycm9ycwogICAgICAgICAgICAgICAgJHN0b3JlRm9yTGF0ZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy9maW5kIG9ycGhhbmVkIHNjaGVkdWxlcwogICAgICAgICAgICAgICAgJHNxbCA9ICRzcWxIZWFkLiRzcWxCb2R5OwogICAgICAgICAgICAgICAgJHVucmVnUmVzdWx0cyA9ICR3cGRiLT5nZXRfcmVzdWx0cygkc3FsKTsKICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAkdW5yZWdPYmogPSBuZXcgc3RkQ2xhc3MoKTsKICAgICAgICAgICAgICAgICR1bnJlZ09iai0+Y291bnQgPSBjb3VudCgkdW5yZWdSZXN1bHRzKTsKICAgICAgICAgICAgICAgICR1bnJlZ09iai0+ZGF0YSA9ICIiOwogICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCR1bnJlZ09iai0+Y291bnQgPiAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICRmaXJzdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJHVucmVnUmVzdWx0cyBhcyAkYVJlc3VsdCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkZmlyc3QpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICR1bnJlZ09iai0+ZGF0YSA9ICRhUmVzdWx0LT5yZWNvcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZmlyc3QgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIAogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdW5yZWdPYmotPmRhdGEgLj0gInx7JGFSZXN1bHQtPnJlY29yZH0iOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkbGljZW5zZSA9IG5ldyBNTV9MaWNlbnNlKCIiLGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdldExpY2Vuc2UoJGxpY2Vuc2UpOyAvL2NhdXNlcyBhIHJlbW90ZSBhdXRoPwogICAgICAgICAgICAgICAgICAgICRwYWNrYWdlZERhdGEgPSBhcnJheSgiYXBpX2tleSIgICAgICAgID0+ICRsaWNlbnNlLT5nZXRBcGlLZXkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFwaV9zZWNyZXQiICAgICA9PiAkbGljZW5zZS0+Z2V0QXBpU2VjcmV0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb21tYW5kIgkJICA9PiAicmVwb3J0VW5yZWdpc3RlcmVkU2NoZWR1bGVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImRhdGEiIAkgICAgICAgICAgPT4gJHVucmVnT2JqCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvL3NlbmQgcGFja2FnZWQgZGF0YSB0byBjZW50cmFsCiAgICAgICAgICAgICAgICAgICAgJHJlc3BvbnNlID0gd3BfcmVtb3RlX3Bvc3QoJHVybCwgYXJyYXkoJ21ldGhvZCcgPT4gJ1BPU1QnLAogICAgICAgICAgICAgICAgICAgICAgICAndGltZW91dCcgPT4gMTIwLAogICAgICAgICAgICAgICAgICAgICAgICAnYm9keSc9PiRwYWNrYWdlZERhdGEpKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoaXNfd3BfZXJyb3IoJHJlc3BvbnNlKSB8fCAoaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddKSAmJiBpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSkgJiYgKCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddICE9ICIyMDAiKSkgfHwgKCFpc3NldCgkcmVzcG9uc2VbJ2JvZHknXSkpICkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVuYWJsZSB0byBjb25uZWN0IHRvIHNlcnZlcgogICAgICAgICAgICAgICAgICAgICAgICAkc3RvcmVGb3JMYXRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICRqc29uID0ganNvbl9kZWNvZGUoJHJlc3BvbnNlWydib2R5J10pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzc2V0KCRqc29uLT5yZXNwb25zZV9jb2RlKSB8fCAoJGpzb24tPnJlc3BvbnNlX2NvZGUgIT0gIjIwMCIpKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3RvcmVGb3JMYXRlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKCRzdG9yZUZvckxhdGVyKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX29wdGlvbigkZGF0YU9wdGlvbk5hbWUsJHVucmVnT2JqLHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAvL3NldCB0aGUgb3B0aW9uIHNvIHRoaXMgZG9lc24ndCBydW4gYWdhaW4KICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsInBlbmRpbmciLHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfb3B0aW9uKCRsb2NrTmFtZSwiY29tcGxldGVkIix0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgkgICAgICAgICB9ICAKCSAgICAgICAgIGVsc2UgaWYgKCRvcHRpb25WYWx1ZSA9PSAicGVuZGluZyIpCgkgICAgICAgICB7CiAgICAgICAgCSAgICAgICAkZGF0YU9wdGlvblZhbHVlID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigkZGF0YU9wdGlvbk5hbWUpOwogICAgICAgIAkgICAgICAgaWYgKCRkYXRhT3B0aW9uVmFsdWUgIT09IGZhbHNlKQogICAgICAgIAkgICAgICAgewogICAgICAgIAkgICAgICAgICAgIC8vdGhlIHNjaGVkdWxpbmcgcmVndWxhdG9yIGNvbXBsZXRlZCwgYnV0IHRoZXJlIHdhcyBwcmV2aW91c2x5IGFuIGlzc3VlIHNlbmRpbmcgdGhlIGRhdGEgdG8gY2VudHJhbCwgdHJ5IGFnYWluCiAgICAgICAgCSAgICAgICAgICAgJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgiIixmYWxzZSk7CiAgICAgICAgCSAgICAgICAgICAgTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZXRMaWNlbnNlKCRsaWNlbnNlKTsKICAgICAgICAJICAgICAgICAgICAgCiAgICAgICAgCSAgICAgICAgICAgJHBhY2thZ2VkRGF0YSA9IGFycmF5KCJhcGlfa2V5IiAgICAgICA9PiAkbGljZW5zZS0+Z2V0QXBpS2V5KCksCiAgICAgICAgCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhcGlfc2VjcmV0IiAgICA9PiAkbGljZW5zZS0+Z2V0QXBpU2VjcmV0KCksCiAgICAgICAgCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJjb21tYW5kIgkJPT4gInJlcG9ydFVucmVnaXN0ZXJlZFNjaGVkdWxlcyIsCiAgICAgICAgCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkYXRhIiAJICAgICAgICA9PiAkZGF0YU9wdGlvblZhbHVlCiAgICAgICAgCSAgICAgICAgICAgKTsKICAgICAgICAJICAgICAgICAgICAgCiAgICAgICAgCSAgICAgICAgICAgJHJlc3BvbnNlID0gd3BfcmVtb3RlX3Bvc3QoJHVybCwgYXJyYXkoJ21ldGhvZCcgPT4gJ1BPU1QnLAogICAgICAgIAkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0aW1lb3V0JyA9PiAxMjAsCiAgICAgICAgCSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknPT4kcGFja2FnZWREYXRhKSk7CiAgICAgICAgCSAgICAgICAgICAgIAogICAgICAgIAkgICAgICAgICAgIGlmIChpc193cF9lcnJvcigkcmVzcG9uc2UpIHx8IChpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ10pICYmIGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddKSAmJiAoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10gIT0gIjIwMCIpKSB8fCAoIWlzc2V0KCRyZXNwb25zZVsnYm9keSddKSkgKQogICAgICAgIAkgICAgICAgICAgIHsKICAgICAgICAJICAgICAgICAgICAgICAgLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCiAgICAgICAgCSAgICAgICAgICAgICAgIE1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsICJVbmFibGUgdG8gdHJhbnNtaXQgb3JwaGFuZWQgc2NoZWR1bGUgcmVzdWx0cyB0byBjZW50cmFsOiAiLnByaW50X3IoJHJlc3BvbnNlLHRydWUpKTsKICAgICAgICAJICAgICAgICAgICB9CiAgICAgICAgCSAgICAgICAgICAgZWxzZQogICAgICAgIAkgICAgICAgICAgIHsKICAgICAgICAJICAgICAgICAgICAgICAgJGpzb24gPSBqc29uX2RlY29kZSgkcmVzcG9uc2VbJ2JvZHknXSk7CiAgICAgICAgCSAgICAgICAgICAgICAgIGlmIChpc3NldCgkanNvbi0+cmVzcG9uc2VfY29kZSkgJiYgKCRqc29uLT5yZXNwb25zZV9jb2RlID09ICIyMDAiKSkKICAgICAgICAJICAgICAgICAgICAgICAgewogICAgICAgIAkgICAgICAgICAgICAgICAgICAgZGVsZXRlX29wdGlvbigkZGF0YU9wdGlvbk5hbWUpOwogICAgICAgIAkgICAgICAgICAgICAgICB9CiAgICAgICAgCSAgICAgICAgICAgfQogICAgICAgIAkgICAgICAgfQogICAgICAgIAkgICAgICAgCiAgICAgICAgCSAgICAgICAvL3JlZ2FyZGxlc3Mgb2Ygb3V0Y29tZSwgc2V0IHBhdGNoIGFzIGNvbXBsZXRlZAogICAgICAgIAkgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsImNvbXBsZXRlZCIsdHJ1ZSk7CgkgICAgICAgICAgfQoJICAgICAgICAgICAKCSAgICAgICAgICAvL25vdyBmb3JjZSByZXJlZ2lzdHJhdGlvbiBvZiBvcnBoYW5lZCBzY2hlZHVsZXMgdXNpbmcgdGhlIHF1ZXVlIHRhYmxlCgkgICAgICAgICAgJHF1ZXVlQ29tbWFuZCA9IChjbGFzc19leGlzdHMoIk1NX1NjaGVkdWxlZEV2ZW50IixmYWxzZSkpP01NX1NjaGVkdWxlZEV2ZW50OjokUVVFVUVfQ09NTUFORF9VUERBVEU6IjAiOwoJICAgICAgICAgICRub3cgPSBNTV9VdGlsczo6Z2V0Q3VycmVudFRpbWUoKTsKCSAgICAgICAgICAkcmVnc3FsU3VicXVlcnkgPSAiU0VMRUNUIHNlLmlkLCAneyRxdWV1ZUNvbW1hbmR9JywgJ3skbm93fScgeyRzcWxCb2R5fSI7CgkgICAgICAgICAgJHFUYWJsZSA9IE1NX1RBQkxFX1FVRVVFRF9TQ0hFRFVMRURfRVZFTlRTOwoJICAgICAgICAgICRyZWdzcWxRdWVyeSA9ICJJTlNFUlQgSU5UTyB7JHFUYWJsZX0gKGV2ZW50X2lkLCBjb21tYW5kLCBxdWV1ZWRfZGF0ZSkgeyRyZWdzcWxTdWJxdWVyeX0iOwoJICAgICAgICAgICR3cGRiLT5xdWVyeSgkcmVnc3FsUXVlcnkpOwoJICAgIAoJICAgICAgICAgIC8vZW5kIGxvY2tlZCBzZWN0aW9uCgkgICAgICAgICAgJHdwZGItPnF1ZXJ5KCJTRUxFQ1QgUkVMRUFTRV9MT0NLKCd7JGxvY2tOYW1lfScpIik7CiAgICAgICAgfQoJfQoJCgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHNlbmRXYXJuaW5nRW1haWwoKQoJewoJCWlmIChjbGFzc19leGlzdHMoIk1NX0VtYWlsIikgJiYgZnVuY3Rpb25fZXhpc3RzKCJ3cF9tYWlsIikpCgkJewoJCQkkc2l0ZVVybCA9IGdldF9vcHRpb24oJ3NpdGV1cmwnKTsKCQkJJGVtcGxveWVlID0gTU1fRW1wbG95ZWU6OmdldERlZmF1bHQoKTsKCQkJJGVtYWlsID0gbmV3IE1NX0VtYWlsKCk7CgkJCSRlbWFpbC0+c2V0Q29udGV4dChuZXcgTU1fQ29udGV4dCgpKTsKCQkJJGVtYWlsLT5zZXRTdWJqZWN0KCJBTEVSVCAtIE1lbWJlck1vdXNlIGRlYWN0aXZhdGlvbiB3YXJuaW5nIGZvciB7JHNpdGVVcmx9Iik7CgkJCSRlbWFpbC0+c2V0RnJvbU5hbWUoIk1lbWJlck1vdXNlIE5vdGlmaWNhdGlvbiIpOwoJCQkkZW1haWwtPnNldEZyb21BZGRyZXNzKCJkby1ub3QtcmVwbHlAbWVtYmVybW91c2UuY29tIik7CgkJCSRlbWFpbC0+c2V0VG9OYW1lKCRlbXBsb3llZS0+Z2V0Rmlyc3ROYW1lKCkpOwoJCQkkZW1haWwtPnNldFRvQWRkcmVzcygkZW1wbG95ZWUtPmdldEVtYWlsKCkpOwoJCQkJCgkJCSRib2R5ID0gIlRoaXMgaXMgYW4gYXV0b21hdGVkIG5vdGljZSB0byBpbmZvcm0geW91IHRoYXQgY29tbXVuaWNhdGlvbiBiZXR3ZWVuIHRoZSBNZW1iZXJNb3VzZSBwbHVnaW4gIi4KCQkJCQkib24geW91ciBzaXRlIHRvIHRoZSBNZW1iZXJNb3VzZSBjZW50cmFsIHNlcnZlciBoYXMgYmVlbiBmYWlsaW5nIG9uIGEgY29uc2lzdGVudCBiYXNpcy4gVGhlICIuCgkJCQkJIm1haW4gY2F1c2VzIGZvciB0aGlzIGFyZSBuZXR3b3JrIG91dGFnZXMgb3IgYmxvY2tzIGJ5IHNlY3VyaXR5IHBsdWdpbnMuXG5cbiIuCgkJCQkJIldlIHJlY29tbWVuZDpcbjEpIHRoYXQgeW91IHdvcmsgd2l0aCB5b3VyIGhvc3QgcHJvdmlkZXIgdG8gcmV2aWV3IHNlcnZlciBsb2dzIG92ZXIgdGhlICIuCgkJCQkJInBhc3QgY291cGxlIG9mIGRheXMgdG8gc2VlIGlmIHRoZXJlIGFyZSBhbnkgZXJyb3JzIHRvIGluZGljYXRlIHdoYXQgbWlnaHQgYmUgb2NjdXJyaW5nIHRvICIuCgkJCQkJImNhdXNlIHRoaXMuIFxuIi4KCQkJCQkiMikgcmV2aWV3IGFueSBuZXcgc2VjdXJpdHkgc2V0dGluZ3Mgb24gdGhlIHNlcnZlciBvciBzZWN1cml0eSBwbHVnaW5zIHRoYXQgbWlnaHQgaGF2ZSBiZWVuICIuCgkJCQkJImFkZGVkLCBhcyB0aGVzZSBjYW4gaW50ZXJmZXJlIHdpdGggY29tbXVuaWNhdGlvblxuXG5BZnRlciBnYXRoZXJpbmcgdGhpcyBpbmZvcm1hdGlvbiAiLgoJCQkJCSJhbmQgbWFraW5nIGFueSBuZWNlc3NhcnkgY2hhbmdlcywgcGxlYXNlIGNvbnRhY3QgdGhlIE1lbWJlck1vdXNlIFN1cHBvcnQgVGVhbSBhdCAiLgoJCQkJCSJzdXBwb3J0QG1lbWJlcm1vdXNlLmNvbSBzbyB3ZSBjYW4gbW9uaXRvciB5b3VyIGxpY2Vuc2UgYW5kIG1ha2Ugc3VyZSB0aGF0IHlvdXIgcGx1Z2luICIuCgkJCQkJInN1Y2Nlc3NmdWxseSBhdXRob3JpemVzLlxuSU1QT1JUQU5UOiBJZiB0aGUgc2l0dWF0aW9uIGlzIG5vdCBmaXhlZCB3aXRoaW4gNyBkYXlzLCAiLgoJCQkJCSJ0aGUgTWVtYmVyTW91c2UgcGx1Z2luIHdpbGwgZGVhY3RpdmF0ZS4iOwoJCQkkZW1haWwtPnNldEJvZHkoJGJvZHkpOwoJCQkJCgkJCSRlbWFpbC0+c2VuZCgpOwoJCX0KCX0KCQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBhY3F1aXJlU2VtYXBob3JlKCkKCXsKCQlnbG9iYWwgJHdwZGI7CgkJCgkJaWYgKCFpc19vYmplY3QoJHdwZGIpKQoJCXsKCQkJcmV0dXJuIC0xOyAvL2Vycm9yCgkJfQoJCQoJCSRsb2NrQWNxdWlyZWQgPSAkd3BkYi0+Z2V0X3Zhcigkd3BkYi0+cHJlcGFyZSgiU0VMRUNUIElGKElTX0ZSRUVfTE9DSyglcyksQ09BTEVTQ0UoR0VUX0xPQ0soJXMsMCksLTEpLDApIixzZWxmOjokQVVUSF9MT0NLX0lERU5USUZJRVIsc2VsZjo6JEFVVEhfTE9DS19JREVOVElGSUVSKSk7CgkJaWYgKCRsb2NrQWNxdWlyZWQgPT0gIjEiKQoJCXsKCQkJc2VsZjo6JEFVVEhfTE9DSyA9IHRydWU7CgkJfQoJCXJldHVybiBpbnR2YWwoJGxvY2tBY3F1aXJlZCk7IC8vLTEgZXJyb3IsIDAgbm90IGFjcXVpcmVkLCAxIGFjcXVpcmVkCgl9CgkKCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gcmVsZWFzZVNlbWFwaG9yZSgpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCWlmIChpc19vYmplY3QoJHdwZGIpICYmIHNlbGY6OiRBVVRIX0xPQ0spCgkJewoJCQkkd3BkYi0+cXVlcnkoJHdwZGItPnByZXBhcmUoIlNFTEVDVCBSRUxFQVNFX0xPQ0soJXMpIixzZWxmOjokQVVUSF9MT0NLX0lERU5USUZJRVIpKTsKCQkJc2VsZjo6JEFVVEhfTE9DSyA9IGZhbHNlOwoJCX0KCX0KfQoK', '1', NOW());";
		if($wpdb->query($addSql) === false)
		{	
			return false;
		}
		return true;
 	}
 	
 	public function authenticateWithMM()
 	{
 		if(class_exists("MM_MemberMouseService"))
 		{
	 		return MM_MemberMouseService::authorize();
 		}
 		return false;
 	}
 	
 	private function alterMMTables()
 	{
 		global $wpdb;
 		
 		$filename = "install_sql";
 		require_once(MM_PLUGIN_ABSPATH."/data/{$filename}.php");	

		if (isset($sql) && count($sql)>0)
		{
			dbdelta($sql);
		}
		
		// Since DBDelta doesn't handle dropping column, here's where we can do it manually & safely. We first 
		// check to see if the column even exists. This could happen if a client has deactivated the 
		// plugin for some reason and then decides to reactivate.
		$droppedColumns = array();
		$droppedColumns[MM_TABLE_USER_DATA][] = "password";
		
		foreach($droppedColumns as $table => $columns)
		{
			foreach($columns as $column)
			{
				if($this->hasColumn($table, $column))
				{
					$wpdb->query("ALTER TABLE {$table} DROP COLUMN {$column}");
				}
			}
		}
		
 		return true;
 	} 	
 	
	private function hasColumn($table, $column)
	{
		global $wpdb;
		
 		$sql = "SELECT COUNT(*) as total FROM information_schema.columns WHERE table_name = '{$table}' AND column_name = '{$column}'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
	}
	
 	private function hasRecords($table, $column, $where)
 	{
 		global $wpdb;
 		
 		$sql = "select count(*) as total from {$table} where {$column}='".addslashes($where)."'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
 	}
 	
 	
 	private function insertMMDefaultData()
 	{
 		global $wpdb, $current_user;
		
 		// insert default option values
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_ENABLED, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_MAX_IPS, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_MAX_IPS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ON_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_ON_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFTER_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_AFTER_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_LOGIN_LOGOUT_LINK, MM_OptionUtils::$DEFAULT_SHOW_LOGIN_LOGOUT_LINK);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_PROTECTED_MENU_ITEMS, MM_OptionUtils::$DEFAULT_HIDE_PROTECTED_MENU_ITEMS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_LOGIN_PAGE, MM_OptionUtils::$DEFAULT_USE_MM_LOGIN_PAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_RESET_PASSWORD_PAGE, MM_OptionUtils::$DEFAULT_USE_MM_RESET_PASSWORD_PAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_COUNTRY_SELECTIONS, MM_OptionUtils::$DEFAULT_COUNTRY_SELECTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_SUBJECT, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_SUBJECT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_BODY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE, MM_OptionUtils::$DEFAULT_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE, MM_OptionUtils::$DEFAULT_SUB_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, MM_OptionUtils::$DEFAULT_AFFILIATE_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_LOGIN_TOKEN_LIFESPAN, MM_OptionUtils::$DEFAULT_LOGIN_TOKEN_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_CHECKOUT_FORM_TEST_DATA, MM_OptionUtils::$DEFAULT_USE_CHECKOUT_FORM_TEST_DATA);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_WIDTH, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_WIDTH);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_HEIGHT, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_HEIGHT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_TYPE, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_TYPE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_ID, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_ID);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_PREVIEW_BAR, MM_OptionUtils::$DEFAULT_SHOW_PREVIEW_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_ADMIN_BAR, MM_OptionUtils::$DEFAULT_HIDE_ADMIN_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_WP_AUTOP, MM_OptionUtils::$DEFAULT_ENABLE_WP_AUTOP);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_USERNAME_CHANGE, MM_OptionUtils::$DEFAULT_ENABLE_USERNAME_CHANGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_LOGGED_OUT_PURCHASES, MM_OptionUtils::$DEFAULT_ALLOW_LOGGED_OUT_PURCHASES);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_DUPLICATE_SUBSCRIPTIONS, MM_OptionUtils::$DEFAULT_ALLOW_DUPLICATE_SUBSCRIPTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_PAID_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_PAID_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_FREE_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_FREE_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_MESSAGE_CSS, MM_OptionUtils::$DEFAULT_CHECKOUT_MESSAGE_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY, MM_OptionUtils::$DEFAULT_CURRENCY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_JQUERY_UI, MM_OptionUtils::$DEFAULT_USE_JQUERY_UI);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_OVERDUE_ACCESS, MM_OptionUtils::$DEFAULT_ALLOW_OVERDUE_ACCESS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_ENABLED, MM_OptionUtils::$DEFAULT_CAPTCHA_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_RESET_PASSWORD, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DIAGNOSTIC_MODE, MM_DiagnosticLog::$MODE_OFF);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORCE_USE_DB_CACHE, 0);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY_FORMAT_POSTFIX_ISO, 'false');
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_ALIAS, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE_ALIAS, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, "");
		
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SITE_IN_TEST_MODE, "0"); //0 for false, 1 for true
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_KEY, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_PRIVATE_KEY, "");
		
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_EMAIL_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ADDRESS_COUNTRY, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ORDER_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ORDER_COUNTRY, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ACTIVITY_LOG, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_CUSTOM_FIELDS, "1");
		
		// options that vary based on if this is an upgrade versus a new install
		$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
		
		if(empty($lastMajorVersion))
		{
			// set options for new installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, MM_OptionUtils::$DEFAULT_DISABLE_EXPLICIT_LINKS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_OptionUtils::$DEFAULT_PURCHASE_LINK_STYLE);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, MM_OptionUtils::$DEFAULT_SMARTTAG_VERSION);
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_ENABLED);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_INTERVAL);
			
			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, MM_OptionUtils::$DEFAULT_ENABLE_MEMBERSHIP_PRORATION);
			
			// for 2.2.5 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_OptionUtils::$DEFAULT_DRIP_CONTENT_TIME_SETTING);
		}
		else
		{
			// set options for existing installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_LINK_STYLE_EXPLICIT);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, "2.0");
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, "");

			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, "0");
			
			// for 2.2.5 release
			if(class_exists('MM_ProtectedContentEngine'))
			{
				MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_ProtectedContentEngine::$TIME_SETTING_SERVER);
			}
			else
			{
				MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_OptionUtils::$DEFAULT_DRIP_CONTENT_TIME_SETTING);
			}
			
			// when upgrading from releases < 2.2.5
			if (version_compare($lastMajorVersion,'2.2.4','<='))
			{
				$wpdb->query("ALTER TABLE ".MM_TABLE_TRANSACTION_LOG." MODIFY COLUMN order_id BIGINT(20) UNSIGNED NOT NULL");
				$wpdb->query("ALTER TABLE ".MM_TABLE_TRANSACTION_LOG." MODIFY COLUMN order_item_id BIGINT(20) UNSIGNED");
			}
		}
 		
 		MM_Role::addRoles();
 		
	 	// create default employee account if one doesn't exist, using the current user
	 	$install_sql = "select * from ".MM_TABLE_EMPLOYEE_ACCOUNTS." where is_default='1' LIMIT 1;";
	 	$row = $wpdb->get_row($install_sql);
	 	if($row == null)
	 	{
	 		//the current user isn't an employee
	 		$install_sql = "insert into ".MM_TABLE_EMPLOYEE_ACCOUNTS." set display_name='%s', email='%s', is_default='%d', role_id='%s', user_id='%d'";
	 		$displayName = (!empty($current_user->display_name)) ? $current_user->display_name : "Support";
	 		$wpdb->query($wpdb->prepare($install_sql, $displayName, $current_user->user_email, 1, MM_Role::$ROLE_ADMINISTRATOR, $current_user->ID));
	 		$emailId = $wpdb->insert_id;
	 	}
	 	else 
	 	{
	 		$emailId = $row->id;
	 	}
	 	
	 	// install default overdue payment notification email
	 	$crntValue = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED);
	 	if(class_exists('MM_Action') && ($crntValue === false || $crntValue === ""))
	 	{
	 		$action = new MM_Action();
	 		$action->setEventType(MM_Event::$MEMBER_STATUS_CHANGE);
	 		$action->setActionType(MM_Action::$MM_ACTION_SEND_EMAIL);
	 			
	 		$emailToId = MM_Action::$CURRENT_MEMBER_PLACEHOLDER;
	 		$emailFromId = $emailId;
	 		$emailCC = "";
	 		$emailSubject = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_SUBJECT;
	 		$emailBody = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_BODY;
	 		$action->setActionValue(MM_Action::prepareSendEmailValue($emailToId, $emailFromId, $emailCC, $emailSubject, $emailBody));
	 			
	 		// set attributes
	 		$attributes = array();
	 		$attributes["status_id"] = MM_Status::$OVERDUE;
	 		$action->setEventAttributes($attributes);
	 		
	 		$result = $action->commitData();
	 		
	 		if(MM_Response::isSuccess($result))
	 		{
	 			MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED, "1");
	 		}
	 	}
	 	
 		// create default membership level
	 	if(!$this->hasRecords(MM_TABLE_MEMBERSHIP_LEVELS, 'is_default', '1'))
	 	{
		 	$install_sql = "INSERT INTO ".MM_TABLE_MEMBERSHIP_LEVELS." SET " .
			 			"	name = 'Free Membership'," .
			 			"	is_free='1'," .
			 			"	is_default='1'," .
			 			"	status='1'," .
			 			"	description='Default Free Membership'," .
			 			"	email_subject='%s'," .
			 			"	email_body='%s'," .
			 			"	email_from_id='%d'" .
			 			"";
		 	
		 	$wpdb->query($wpdb->prepare($install_sql, MM_MembershipLevel::$DFLT_EMAIL_SUBJECT, MM_MembershipLevel::$DFLT_EMAIL_BODY, $emailId));
	 	}
	 	
	 	// create default commission profile
	 	if(!$this->hasRecords(MM_TABLE_COMMISSION_PROFILES, 'is_default', '1'))
	 	{
	 		$install_sql = "INSERT INTO ".MM_TABLE_COMMISSION_PROFILES." SET " .
	 				"	name = 'Standard Commission Profile'," .
		 			"	is_default='1'," .
		 			"	description='This is the default commission profile'," .
		 			"	initial_commission_enabled='1'," .
		 			"	rebill_commissions_enabled='0'," .
		 			"	rebill_commission_type='default'," .
		 			"	rebill_commission_value='0'," .
		 			"	do_limit_rebill_commissions='0'," .
		 			"	rebill_commission_limit='0', " .
		 			"	do_reverse_commissions='1'" .
	 				"";
	 	
	 		$wpdb->query($install_sql);
	 	}
 		
 		// make sure active payment services are updated
 		if(class_exists('MM_PaymentServiceFactory') && class_exists('MM_PaymentService'))
 		{
	 		$services = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 			
	 		foreach ($services as $service)
	 		{
	 			if ($service instanceof MM_PaymentService)
	 			{
	 				$service->install();
	 			}
	 		}
 		}
 		
 		//add smart tags
	 	$this->addSmartTags();
	 	
	 	$sql = "select count(*) as total from ".MM_TABLE_API_KEYS;
	 	$row = $wpdb->get_row($sql);
	 	
	 	if($row->total<=0)
	 	{
	 		$sql = "insert into ".MM_TABLE_API_KEYS." set ".
		 		   "name='Default Access', ".
		 		   "api_key='".MM_Utils::createRandomString(10)."',	".
		 		   "api_secret='".MM_Utils::createRandomString(10)."', ".
		 		   "status='1'";
	 		
		 	$wpdb->query($sql);
	 	}
	 	
	 	$sql = array();
	 	require_once(MM_PLUGIN_ABSPATH."/data/countries.sql.php");
	 	$numCountries = count($sql);
	 	$countryCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRIES;
	 	$row = $wpdb->get_row($countryCheckSql);
	 	if ($row->total < $numCountries)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
	 	
	 	$sql = array();
	 	require_once(MM_PLUGIN_ABSPATH."/data/country_subdivisions.sql.php");
	 	$numCountrySubdivisions = count($sql);
	 	$countrySubdivisionCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRY_SUBDIVISIONS;
	 	$row = $wpdb->get_row($countrySubdivisionCheckSql);
	 	if ($row->total < $numCountrySubdivisions)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
		
	 	$result = $this->setupCorePages();
	 	
	 	if(!$result)
	 	{
	 		return false;
	 	}
	 	
	 	$cacheWriteable = @MM_Utils::cacheIsWriteable();
	 		
	 	$sql = array();
	 		
	 	//TODO TRANSIENT: in version 2.0.1 renamed WordPress Mail to None. Once all customers have been upgraded to None then this 
	 	// if statement can be removed
	 	if($this->hasRecords(MM_TABLE_EMAIL_SERVICE_PROVIDERS, 'provider_token', 'default'))
	 	{
	 		$sql[] = "UPDATE ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None' WHERE provider_token='default';";
	 	}
	 	else 
	 	{
	 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	}
	 
	 	//email service providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='ActiveCampaign', provider_token='activecampaign', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='MailChimp', provider_token='mailchimp', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='iContact', provider_token='icontact', api_key='".MM_IContactEmailServiceProvider::$API_KEY."'";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='AWeber', provider_token='aweber', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='GetResponse', provider_token='getresponse', active='0';";
	 	
	 	//affiliate providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='iDevAffiliate', provider_token='idevaffiliate';";
	 		
	 	//payment services
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='PAYPAL', name='PayPal', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENET', name='Authorize.net', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENETCIM', name='Authorize.net CIM', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='BRAINTREE', name='Braintree', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CHARGIFY', name='Chargify', settings='', active='0';";
	 	
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STICKYIO', name='Sticky.io', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LIMELIGHT', name='Lime Light (Legacy)', settings='', active='0';";
	 	
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STRIPE', name='Stripe', settings='', active='0';";
		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='TWOCHECKOUT', name='2Checkout', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CLICKBANK', name='ClickBank', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LITLE', name='Litle', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASE', name='Coinbase (Wallet Required)', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASEMINIMAL', name='Coinbase (Wallet Ignored)', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='TEST', name='Test Payment Service', settings='', active='0';";
	 	
	 	//shipping methods
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_SHIPPING_METHODS." SET token='FLATRATE', name='Flat Rate', settings='', active='1';"; //active by default
	 	
	 	foreach ($sql as $query)
	 	{
	 		$wpdb->query($query);
	 	}
	 	unset($sql);
	 	
	 	
	 	//apply any updates that may have been made to the schemas of the active payment services
	 	$activePaymentServices = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 	foreach ($activePaymentServices as $ps)
	 	{
	 		$ps->install();
	 	}
	 	
		// Need to search and replace and remnance of [MM_Member_Data name='password'] in 
		// Forgot Password email with the new Reset Password Core Page Link Smart Tag
		$pattern 			  = "\[mm_member_data name=(['|\"]{1})password(['|\"]{1})\]";
		$forgotPasswordBody = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY);
		$forgotPasswordBody = preg_replace("/{$pattern}/i", "<a href=\"[MM_CorePage_Link type='resetpassword']\">click here to reset your password</a>", $forgotPasswordBody);
		MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, $forgotPasswordBody);
		
	 	return true;
 	}
 	
 	
 	public function setupCorePages()
 	{
 		global $wpdb, $current_user;
 		
 		// Core Page Types
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MEMBER_HOME_PAGE."','Member Home','1');";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$SAVETHESALE."','Save the Sale','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$ERROR."','Error','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGIN_PAGE."','Login','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FORGOT_PASSWORD."','Forgot Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$RESET_PASSWORD."','Reset Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$CHECKOUT."','Checkout','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$REDEEM_GIFT."','Redeem Gift','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$PAID_CONFIRMATION."','Confirmation','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FREE_CONFIRMATION."','Free Confirmation','0');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MY_ACCOUNT."','My Account','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGOUT_PAGE."','Logout','1');";
 			
	 	// Default Core Pages
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('1', '".MM_CorePageType::$MEMBER_HOME_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('2', '".MM_CorePageType::$SAVETHESALE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('3', '".MM_CorePageType::$ERROR."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('4', '".MM_CorePageType::$LOGIN_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('5', '".MM_CorePageType::$FORGOT_PASSWORD."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('6', '".MM_CorePageType::$CHECKOUT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('7', '".MM_CorePageType::$PAID_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('9', '".MM_CorePageType::$FREE_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('10', '".MM_CorePageType::$MY_ACCOUNT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('11', '".MM_CorePageType::$LOGOUT_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('12', '".MM_CorePageType::$REDEEM_GIFT."');";
	 	
	 	foreach($sql as $query)
	 	{
	 		if($wpdb->query($query) === false)
	 		{
	 			echo $query;
	 			return false;
	 		}
	 	}
	 	unset($sql);
 		
	 	// Install Default Core Pages
	 	$templateParams = new stdClass();
	 	$templateParams->resourceDirectory = MM_RESOURCES_URL;
	 	$mm_template_base = MM_PLUGIN_ABSPATH."/templates";
	 	
		// Member Homepage
 		$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MEMBER_HOME_PAGE."' and ref_type IS NULL and page_id IS NULL";
 		$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{	
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/homepage.html.php", $templateParams))."', '[MM_Member_Data name=\"membershipName\"] Home Page', '".$this->getPostName('home')."');";
	 		
 			if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MEMBER_HOME_PAGE);
	 	}
	 	
	 	// Save-the-Sale Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$SAVETHESALE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/cancel.html.php", $templateParams))."', 'Cancel Membership', '".$this->getPostName('cancel')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$SAVETHESALE);
	 	}
	 	
	 	// Error Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$ERROR."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
		{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/error.html.php", $templateParams))."', 'Error', '".$this->getPostName('mm-error')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$ERROR);
	 	}
	 	
	 	// Login Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGIN_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/login.html.php", $templateParams))."', 'Login', '".$this->getPostName('login')."');";
		 		
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGIN_PAGE);
	 	}

	 	// Logout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGOUT_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/logout.html.php", $templateParams))."', 'Logout', '".$this->getPostName('logout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGOUT_PAGE);
	 	}
	 	
	 	// Forgot Password Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$FORGOT_PASSWORD."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/forgotpassword.html.php", $templateParams))."', 'Forgot Password', '".$this->getPostName('forgot-password')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$FORGOT_PASSWORD);
	 	}
	 	
	 	// Reset Password Page
	 	// remove corrupt reset password core pages
	 	$removeCorruptResetPasswordSql = "DELETE FROM ".MM_TABLE_CORE_PAGES." WHERE core_page_type_id = '".MM_CorePageType::$RESET_PASSWORD."' AND (page_id IS NULL || page_id = '');";
	 	$wpdb->query($removeCorruptResetPasswordSql);
	 	
	 	$corePageSql = "select id, page_id, count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$RESET_PASSWORD."'";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	// it's possible that the reset password core page isn't being installed as a result of some corrupt 
	 	// core pages that we only partially installed (the page_id == NULL checks for that). We want to detect 
	 	// these so that their presense doesn't keep the fully functional page from being installed.
	 	if($row->total == 0 || $row->page_id == NULL)
	 	{	
	 		// create row in mm_core_pages table
	 		$resetPasswordSql ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (core_page_type_id) VALUES ('".MM_CorePageType::$RESET_PASSWORD."');";
	 		
	 		if(!$wpdb->query($resetPasswordSql))
	 		{
	 			echo $resetPasswordSql;
	 			return false;
	 		}
	 		
	 		$resetCorePageId = $wpdb->insert_id;
	 		
	 		// create reset password page
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 		"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/resetpassword.html.php", $templateParams))."', 'Reset Password', '".$this->getPostName('reset-password')."');";
	 		
	 		if(!$wpdb->query($sql))
	 		{
	 			echo $sql;
	 			return false;
	 		}
	 		
	 		// link row in mm_core_pages table to reset password page
 			$this->linkCorePage($wpdb->insert_id, $resetCorePageId);
	 	}
	 	
	 	// Checkout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$CHECKOUT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/checkout.html.php", $templateParams))."', 'Checkout', '".$this->getPostName('checkout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$CHECKOUT);
	 	}
	 	
	 	// Redeem Gift Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$REDEEM_GIFT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/redeemgift.html.php", $templateParams))."', 'Redeem Gift', '".$this->getPostName('redeem-gift')."');";
	 				
	 		if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$REDEEM_GIFT);
	 	}
	 	
	 	// My Account Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MY_ACCOUNT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/myaccount.html.php", $templateParams))."', 'My Account', '".$this->getPostName('myaccount')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MY_ACCOUNT);
	 	}
	 	
	 	// Paid Confirmation Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$PAID_CONFIRMATION."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/confirmation.html.php", $templateParams))."', 'Thank You', '".$this->getPostName('confirmation')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$PAID_CONFIRMATION);
	 	}
	 	
 		return true;
 	}
 	
 	private function addSmartTags()
 	{
 		global $wpdb;
 		
 		$wpdb->query("DELETE FROM ".MM_TABLE_SMARTTAGS);
 		require_once(MM_PLUGIN_ABSPATH."/data/smarttags.sql.php");
 		if(isset($sql) && is_array($sql))
 		{
 			foreach($sql as $query)
 			{
 				if($wpdb->query($query)===false){ 
 					return false;	
 				}
 			}
 		}
 		
 		//clear global SmartTag cache
 		MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_SMARTTAGS);
 		
 		return true;
 	}
 	
 	private function getPostName($suggestedName=""){
 		global $wpdb;
 		$sql = "select count(*) as total from {$wpdb->posts} where post_name='".$suggestedName."'";
 		$row = $wpdb->get_row($sql);
 		if($row->total>0){
	 		$sql = "select post_name from {$wpdb->posts} where post_name like '".$suggestedName."-%'";
	 		$rows = $wpdb->get_results($sql);
	 		
	 		$index=1;
	 		while(true){
	 			$newName = $suggestedName."-".$index;
	 			$hasName = false;
	 			foreach($rows as $row){
	 				if($row->post_name == $newName){
	 					$hasName = true;		
	 				}
	 			}
	 			if(!$hasName){
	 				return $newName;
	 			}
	 			$index++;
	 		}
 		}
 		return $suggestedName;
 	}
 	
 	private function linkCorePage($page_id, $id)
 	{
		global $wpdb;
		$sql = "update ".MM_TABLE_CORE_PAGES." set page_id='{$page_id}' where id='{$id}'";
		
		if(!$wpdb->query($sql))
		{
			echo $sql;
			return false;
		}
 	}
 	
	private function field_exists($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
	
		for($i=0; $i<count($rows); $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return true;
			}
		}
		
		return false;
	}
	
	private function getFieldType($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
		
		$numRows = count($rows);
		for($i=0; $i<$numRows; $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return $rows[$i]->Type;
			}
		}
		
		return false;
	}
 }